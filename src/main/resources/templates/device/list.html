<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>장비 목록</title>
    <link rel="stylesheet" href="/device.css" />
    <link rel="stylesheet" href="/main.css" />
    <link rel="stylesheet" href="/navbar.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        
        .alert-dismissible {
            position: relative;
        }
        
        .btn-close {
            position: absolute;
            top: 0;
            right: 0;
            z-index: 2;
            padding: 15px;
            background: transparent;
            border: 0;
            font-size: 20px;
            cursor: pointer;
            color: #155724;
        }
        
        .btn-close:hover {
            color: #0f5132;
        }
        
        /* 주황색 버튼 스타일 */
        .btn-orange {
            background-color: #ff8c00;
            border-color: #ff8c00;
            color: white;
        }
        
        .btn-orange:hover {
            background-color: #e67e00;
            border-color: #e67e00;
            color: white;
        }
        
        .btn-orange:focus {
            background-color: #e67e00;
            border-color: #e67e00;
            color: white;
            box-shadow: 0 0 0 0.2rem rgba(255, 140, 0, 0.25);
        }
        
        .alert i {
            margin-right: 8px;
        }
        
        /* 검색 기능 스타일 */
        .search-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
            padding: 0 20px;
        }
        
        .search-form {
            width: 100%;
            max-width: 600px;
        }
        
        .search-input-group {
            display: flex;
            align-items: center;
            background: white;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .search-input-group:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        
        .search-input {
            flex: 1;
            padding: 15px 20px;
            border: none;
            outline: none;
            font-size: 16px;
            background: transparent;
        }
        
        .search-input::placeholder {
            color: #999;
            font-style: italic;
        }
        
        .search-btn {
            padding: 15px 20px;
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 16px;
        }
        
        .search-btn:hover {
            background: #0056b3;
        }
        
        .search-btn i {
            font-size: 18px;
        }
        
        /* 검색 키워드 강조 표시 스타일 */
        .search-highlight {
            background-color: transparent;
            color: #d32f2f;
            font-weight: bold;
            text-shadow: 0 0 1px rgba(255, 255, 255, 0.8);
        }
        
        .search-highlight:hover {
            color: #b71c1c;
            text-shadow: 0 0 2px rgba(255, 255, 255, 0.9);
            transition: all 0.2s ease;
        }
        
        /* 학교 선택 안내 메시지 스타일 */
        .school-selection-message {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin: 30px 0;
        }
        
        .message-container {
            text-align: center;
            padding: 40px;
        }
        
        .message-container i {
            font-size: 4rem;
            color: #6b7280;
            margin-bottom: 20px;
        }
        
        .message-container h3 {
            font-size: 1.5rem;
            color: #374151;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .message-container p {
            font-size: 1rem;
            color: #6b7280;
            margin: 0;
        }
        
        /* 검사모드 관련 스타일 */
        .inspection-checkbox {
            cursor: pointer;
            text-align: center;
            padding: 5px;
        }
        
        .inspection-icon {
            font-size: 20px;
            transition: color 0.2s ease;
        }
        
        /* 모바일 검사확인 체크박스 스타일 */
        .inspection-checkbox-mobile {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: #f3f4f6 !important;
            border: 2px solid #e5e7eb !important;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease !important;
            height: 38px; /* 버튼 높이와 맞춤 */
            box-sizing: border-box;
        }
        
        .inspection-checkbox-mobile.state-unchecked {
            background: #f3f4f6 !important;
            border-color: #e5e7eb !important;
        }
        
        .inspection-checkbox-mobile.state-confirmed {
            background: #e8f5e9 !important;
            border-color: #28a745 !important;
        }
        
        .inspection-checkbox-mobile.state-modified {
            background: #fff7e6 !important;
            border-color: #ffc107 !important;
        }
        
        .inspection-checkbox-mobile:hover {
            opacity: 0.9;
        }
        
        .inspection-checkbox-mobile .inspection-icon {
            font-size: 18px;
            transition: color 0.2s ease;
        }
        
        .inspection-checkbox-mobile .inspection-label {
            font-size: 14px;
            font-weight: 500;
            color: #495057;
        }
        
        .inspection-checkbox-mobile:hover .inspection-label {
            color: #1976d2;
        }
        
        /* 모바일 카드 액션 버튼들 정렬 */
        .card-actions {
            display: flex;
            flex-direction: row; /* 가로 배열 */
            gap: 8px;
            align-items: center; /* 세로 중앙 정렬 */
            justify-content: flex-start; /* 왼쪽부터 정렬 */
            flex-wrap: wrap; /* 공간 부족 시 줄바꿈 허용 */
        }
        
        .card-actions .inspection-checkbox-mobile {
            height: 38px; /* 세로 크기 유지 */
            /* 너비는 내용에 따라 자동으로 조절 */
        }

        .card-actions .btn,
        .card-actions form { /* 수정, 삭제 버튼과 폼을 flex item으로 처리 */
            height: 38px;
            display: flex; /* 내부 요소 정렬을 위해 flex 사용 */
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            flex: 1; /* 남은 공간을 균등하게 분배하여 같은 너비 유지 */
            min-width: 0; /* flex item이 내용보다 작아질 수 있도록 허용 */
        }

        .card-actions form {
            margin: 0; /* 폼의 기본 마진 제거 */
        }

        .card-actions form button.btn {
            width: 100%; /* 폼 내부 버튼이 폼의 전체 너비를 차지하도록 */
        }
        
        .inspection-icon.unchecked {
            color: #ccc !important;
        }
        
        .inspection-icon.confirmed {
            color: #28a745 !important;
        }
        
        .inspection-icon.modified {
            color: #ffc107 !important;
        }
        
        /* 검색 옵션 스타일 */
        .search-option {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            color: #333;
        }
        
        .search-option input[type="checkbox"] {
            margin-right: 5px;
        }
        
        /* 모달 스타일 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 1.5rem 2rem;
            text-align: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }
        
        .modal-body {
            padding: 2rem;
        }
        
        .school-search {
            margin-bottom: 1.5rem;
        }
        
        .school-search input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .school-search input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .school-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .school-item {
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .school-item:hover {
            background: #f8fafc;
            border-color: #3b82f6;
        }
        
        .school-item.selected {
            background: #dbeafe;
            border-color: #3b82f6;
        }
        
        .modal-footer {
            padding: 1.5rem 2rem;
            background: #f8fafc;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        
        .confirm-btn, .cancel-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .confirm-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .confirm-btn:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        
        .cancel-btn {
            background: #6b7280;
            color: white;
        }
        
        .cancel-btn:hover {
            background: #4b5563;
        }
        
        .school-select {
            margin-bottom: 1rem;
        }
        
        .school-select label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }
        
        .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            transition: border-color 0.3s ease;
        }
        
        .search-option {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            font-size: 0.9rem;
            color: #374151;
            transition: all 0.3s ease;
            padding: 8px 12px;
            border-radius: 8px;
            background: #f8fafc;
            border: 2px solid #e5e7eb;
        }
        
        .search-option:hover {
            background: #e0f2fe;
            border-color: #0ea5e9;
            color: #0c4a6e;
        }
        
        .search-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #dee2e6;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin: 0 5px;
        }
        
        .search-option:hover {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-color: #2196f3;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(33, 150, 243, 0.15);
        }
        
        .search-option input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #2196f3;
            cursor: pointer;
            transform: scale(1.1);
            margin: 0;
        }
        
        .search-option span {
            font-size: 14px;
            font-weight: 500;
            color: #495057;
            cursor: pointer;
            user-select: none;
            transition: all 0.3s ease;
        }
        
        .search-option:hover span {
            color: #1976d2;
        }
        
        .search-option input[type="checkbox"]:checked + span {
            font-weight: 600;
            color: #1976d2;
        }
        
        /* 모바일 반응형 스타일 */
        @media (max-width: 768px) {
            #searchForm {
                display: flex;
                flex-direction: column; /* 자식 요소들을 세로로 배치 */
                align-items: stretch; /* 자식 요소들이 부모 너비를 채우도록 */
                gap: 10px; /* 검색창과 체크박스 그룹 사이 간격 */
            }

            .search-input-group {
                width: 100%; /* 검색창이 전체 너비를 차지하도록 */
            }

            .search-options {
                flex-direction: row !important; /* 체크박스 자체는 가로로 유지 */
                justify-content: center !important;
                gap: 8px !important;
                margin-top: 0 !important; /* #searchForm의 gap으로 간격 처리 */
            }
            
            .search-option {
                flex: 1;
                min-width: 0;
                padding: 8px 12px;
                margin: 0 !important;
            }
            
            .search-option span {
                font-size: 13px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .search-option input[type="checkbox"] {
                transform: scale(0.9);
            }
        }
        
        /* 태블릿 반응형 스타일 */
        @media (max-width: 1024px) and (min-width: 769px) {
            .search-options {
                gap: 15px !important;
            }
            
            .search-option {
                padding: 10px 14px;
            }
        }
    </style>
</head>
<body>
    <!-- 네비게이션 바 포함 -->
    <div th:replace="~{fragments/navbar :: navbar}"></div>
    
    <div class="container">
        <div class="device-list-container" style="position: relative;">
                        <!-- 검사모드 전용 버튼들 (컨테이너 우측 상단) -->
                        <div id="inspectionModeButtons" th:style="${inspectionMode ? 'display: block;' : 'display: none;'}" style="position: absolute; top: 20px; right: 20px; z-index: 100;">
                            <button class="btn btn-danger" onclick="resetInspection()" style="float: right;">
                                <i class="fas fa-undo"></i> 초기화
                            </button>
                        </div>
            
            <!-- 성공 메시지 표시 -->
            <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle"></i>
                <span th:text="${successMessage}"></span>
                <button type="button" class="btn-close" onclick="this.parentElement.style.display='none'"></button>
            </div>
            
            <div class="title">
                <div class="subject" id="pageTitle" th:text="${inspectionMode ? '장비검사' : '장비 목록'}">장비 목록</div>
                <div class="subtitle" id="pageSubtitle" th:text="${inspectionMode ? '장비 상태를 확인하고 검사하세요!' : '학교별, 유형별로 장비를 관리하세요!'}">학교별, 유형별로 장비를 관리하세요!</div>
            </div>
            
            <!-- 검색 기능 -->
            <div class="search-container">
                <form th:action="@{/device/list}" method="get" class="search-form" id="searchForm">
                    <input type="hidden" name="schoolId" th:value="${selectedSchoolId}" />
                    <input type="hidden" name="classroomId" th:value="${selectedClassroomId}" />
                    <input type="hidden" name="type" th:value="${selectedType}" />
                    <input type="hidden" name="page" value="1" />
                    <input type="hidden" name="size" th:value="${pageSize}" />
                    <input type="hidden" name="inspectionMode" id="inspectionModeParam" />
                    <input type="hidden" name="showClassroomsWithDevices" id="searchShowClassroomsWithDevices" />
                    
                    <div class="search-input-group">
                        <input type="text" name="searchKeyword" 
                               th:value="${searchKeyword}" 
                               placeholder="모델명, 제조사, IP주소, 고유번호로 검색" 
                               class="search-input" id="searchInput" />
                        <button type="submit" class="search-btn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    
                    <!-- 검색 옵션 체크박스들 -->
                    <div class="search-options" style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                        <label class="search-option">
                            <input type="checkbox" id="showClassroomsWithDevices" th:checked="${showClassroomsWithDevices}" />
                            <span>장비가 있는 교실</span>
                        </label>
                        <label class="search-option">
                            <input type="checkbox" id="qrCodeSearch" />
                            <span>QR코드검색</span>
                        </label>
                    </div>
                </form>
                <script>
                    // QR코드 검색 체크박스 상태 즉시 복원 (페이지 로드 전)
                    (function() {
                        const savedQrCodeSearch = localStorage.getItem('qrCodeSearch');
                        if (savedQrCodeSearch === 'true') {
                            const qrCheckbox = document.getElementById('qrCodeSearch');
                            if (qrCheckbox) {
                                qrCheckbox.checked = true;
                            }
                        }
                    })();
                </script>
            </div>
            <div class="main">
                <div class="filter-container">
                    <form th:action="@{/device/list}" method="get" class="d-flex align-items-center" id="filterForm">
                        <input type="hidden" name="inspectionMode" id="filterInspectionModeParam" />
                        <input type="hidden" name="schoolId" id="filterSchoolIdParam" th:value="${selectedSchoolId}" />
                        <input type="hidden" name="searchKeyword" th:value="${searchKeyword}" />
                        <input type="hidden" name="page" value="1" />
                        <input type="hidden" name="size" th:value="${pageSize}" />
                        <input type="hidden" name="showClassroomsWithDevices" id="filterShowClassroomsWithDevices" />
                        <select name="schoolId" id="schoolSelect" onchange="updateClassroomsAndSubmit(this.value)" th:disabled="${inspectionMode}">
                            <option value="">전체 학교</option>
                            <option th:each="school : ${schools}" 
                                    th:value="${school.schoolId}"
                                    th:text="${school.schoolName}"
                                    th:selected="${selectedSchoolId} == ${school.schoolId}">
                            </option>
                        </select>
                        <select name="classroomId" id="classroomSelect" onchange="updateSchoolIdAndSubmit()">
                            <option value="">전체 교실</option>
                            <option th:each="classroom : ${classrooms}" 
                                    th:value="${classroom.classroomId}"
                                    th:text="${classroom.roomName}"
                                    th:selected="${selectedClassroomId} == ${classroom.classroomId}">
                            </option>
                        </select>
                        <select name="type" onchange="updateSchoolIdAndSubmit()">
                            <option value="">전체 유형</option>
                            <option th:each="t : ${types}"
                                    th:value="${t}"
                                    th:text="${t}"
                                    th:selected="${selectedType} == ${t}">
                            </option>
                        </select>
                        <input type="hidden" name="page" value="1" />
                        <input type="hidden" name="size" th:value="${pageSize}" />
                    </form>
                    <div class="action-buttons-container">
                        <a href="/device/register" class="btn btn-primary">
                            <i class="fas fa-plus-circle" style="color: white;"></i> <span style="color: white;">장비 등록</span>
                        </a>
                        <button id="inspectionModeBtn" class="btn btn-warning" onclick="openInspectionMode()" th:style="${inspectionMode ? 'display: none;' : ''}">
                            <i class="fas fa-clipboard-check" style="color: white;"></i> <span style="color: white;">장비검사</span>
                        </button>
                        <button id="deviceListBtn" class="btn btn-orange" onclick="openDeviceList()" th:style="${inspectionMode ? '' : 'display: none;'}">
                            <i class="fas fa-list" style="color: white;"></i> <span style="color: white;">장비목록</span>
                        </button>
                        <a th:href="@{/device/excel(schoolId=${selectedSchoolId}, type=${selectedType}, classroomId=${selectedClassroomId})}" class="btn btn-success" id="excelDownloadBtn" onclick="downloadExcelWithInspection()">
                            <i class="fas fa-file-excel" style="color: white;"></i> <span style="color: white;">엑셀 다운로드</span>
                        </a>
                        <a th:href="@{/device/history/list(schoolId=${selectedSchoolId})}" class="btn btn-info">
                            <i class="fas fa-history"></i> <span>수정내역</span>
                        </a>
                    </div>
                    
                </div>
                
                <!-- 학교 선택 안내 메시지 -->
                <div th:if="${selectedSchoolId == null or selectedSchoolId == ''}" class="school-selection-message">
                    <div class="message-container">
                        <i class="fas fa-school"></i>
                        <h3>학교를 선택해주세요</h3>
                        <p>장비 목록을 보려면 위에서 학교를 선택해주세요.</p>
                    </div>
                </div>
                
                <!-- 데스크톱 테이블 뷰 -->
                <table th:if="${selectedSchoolId != null and selectedSchoolId != ''}" class="device-table">
                    <thead>
                        <tr>
                            <th>학교</th>
                            <th>고유번호</th>
                            <th>관리번호</th>
                            <th>유형</th>
                            <th>직위</th>
                            <th>담당자</th>
                            <th>제조사</th>
                            <th>모델명</th>
                            <th>도입일자</th>
                            <th>IP주소</th>
                            <th>교실</th>
                            <th>용도</th>
                            <th>set분류</th>
                            <th>비고</th>
                            <th>불용</th>
                            <th>관리</th>
                            <th id="inspectionColumn" th:style="${inspectionMode ? '' : 'display: none;'}">검사확인</th>
                        </tr>
                    </thead>
                    <tbody>
                        <th:block th:each="device, iterStat : ${devices}">
                            <!-- 교실 헤더 표시 (새로운 교실일 때) -->
                            <tr th:if="${iterStat.index == 0 or device.classroom?.roomName != devices[iterStat.index - 1].classroom?.roomName}" 
                                class="classroom-header">
                                <td colspan="16">
                                    <strong>
                                        <i class="fas fa-door-open"></i> 
                                        <span th:text="${device.classroom != null and device.classroom.roomName != null ? device.classroom.roomName : '미지정 교실'}"></span>
                                    </strong>
                                </td>
                            </tr>
                            
                            <!-- 세트타입 그룹 헤더 표시 (새로운 세트타입일 때) -->
                            <tr th:if="${device.setType != null and !device.setType.isEmpty() and 
                                       (iterStat.index == 0 or 
                                        device.classroom?.roomName != devices[iterStat.index - 1].classroom?.roomName or
                                        device.setType != devices[iterStat.index - 1].setType)}" 
                                class="group-header">
                                <td colspan="16">
                                    <strong>
                                        <i class="fas fa-layer-group"></i> 
                                        세트: <span th:text="${device.setType}"></span>
                                    </strong>
                                </td>
                            </tr>
                            
                            <!-- 담당자 그룹 헤더 표시 (세트가 없고 새로운 담당자일 때) -->
                            <tr th:if="${(device.setType == null or device.setType.isEmpty()) and 
                                       device.operator != null and device.operator.name != null and
                                       (iterStat.index == 0 or 
                                        device.classroom?.roomName != devices[iterStat.index - 1].classroom?.roomName or
                                        device.operator?.name != devices[iterStat.index - 1].operator?.name)}" 
                                class="group-header">
                                <td colspan="16">
                                    <strong>
                                        <i class="fas fa-user"></i> 
                                        담당자: <span th:text="${device.operator.name}"></span>
                                        <span th:if="${device.operator.position != null}">
                                            (<span th:text="${device.operator.position}"></span>)
                                        </span>
                                    </strong>
                                </td>
                            </tr>
                            
                            <!-- 장비 데이터 행 -->
                            <tr th:class="${device.setType != null and !device.setType.isEmpty() ? 'set-group-item' : 'operator-group-item'}">
                                <td data-label="학교" th:text="${device.school != null ? device.school.schoolName : '미지정'}"></td>
                                <td data-label="고유번호" th:utext="${device.uid != null ? @deviceService.highlightSearchKeyword(device.uid.displayUid, searchKeyword) : ''}"></td>
                                <td data-label="관리번호" th:text="${device.manage != null ? device.manage.displayId : ''}"></td>
                                <td data-label="유형" class="device-type" th:text="${device.type != null ? device.type : ''}"></td>
                                <td data-label="직위" th:text="${device.operator != null && device.operator.position != null ? device.operator.position : ''}"></td>
                                <td data-label="담당자" th:text="${device.operator != null && device.operator.name != null ? device.operator.name : ''}"></td>
                                <td data-label="제조사" th:utext="${device.manufacturer != null ? @deviceService.highlightSearchKeyword(device.manufacturer, searchKeyword) : ''}"></td>
                                <td data-label="모델명" th:utext="${device.modelName != null ? @deviceService.highlightSearchKeyword(device.modelName, searchKeyword) : ''}"></td>
                                <td data-label="구매일자" th:text="${device.purchaseDate != null ? #temporals.format(device.purchaseDate, 'yyyy년 MM월') : ''}"></td>
                                <td data-label="IP주소" class="ip-address" th:utext="${device.ipAddress != null ? @deviceService.highlightSearchKeyword(device.ipAddress, searchKeyword) : ''}"></td>
                                <td data-label="교실" th:text="${device.classroom != null && device.classroom.roomName != null ? device.classroom.roomName : ''}"></td>
                                <td data-label="용도" th:text="${device.purpose != null ? device.purpose : ''}"></td>
                                <td data-label="세트분류" th:text="${device.setType != null ? device.setType : ''}"></td>
                                <td data-label="비고" th:text="${device.note != null ? device.note : ''}"></td>
                                <td data-label="불용" th:text="${device.unused != null && device.unused ? 'Y' : 'N'}"></td>
                                <td data-label="관리">
                                    <div class="action-buttons">
                                        <a th:href="@{/device/modify/{id}(id=${device.deviceId})}" class="btn btn-warning">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <form th:action="@{/device/remove}" method="post" style="display: inline;">
                                            <input type="hidden" name="device_id" th:value="${device.deviceId}">
                                            <button type="submit" class="btn btn-danger" onclick="return confirm('정말 삭제하시겠습니까?')">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                                <td data-label="검사확인" id="inspectionCell" th:style="${inspectionMode ? '' : 'display: none;'}">
                                    <div class="inspection-checkbox" th:data-device-id="${device.deviceId}" onclick="toggleInspection(this)">
                                        <i th:if="${inspectionStatuses != null and inspectionStatuses.containsKey(device.deviceId) and inspectionStatuses.get(device.deviceId) == 'confirmed'}" 
                                           class="fas fa-check-circle inspection-icon confirmed" 
                                           style="color: #28a745;"></i>
                                        <i th:if="${inspectionStatuses != null and inspectionStatuses.containsKey(device.deviceId) and inspectionStatuses.get(device.deviceId) == 'modified'}" 
                                           class="fas fa-check-circle inspection-icon modified" 
                                           style="color: #ffc107;"></i>
                                        <i th:if="${inspectionStatuses == null or !inspectionStatuses.containsKey(device.deviceId) or inspectionStatuses.get(device.deviceId) == 'unchecked'}" 
                                           class="fas fa-check-circle inspection-icon unchecked" 
                                           style="color: #ccc;"></i>
                                    </div>
                                </td>
                            </tr>
                        </th:block>
                    </tbody>
                </table>
                
                <!-- 모바일 카드 뷰 -->
                <div th:if="${selectedSchoolId != null and selectedSchoolId != ''}" class="mobile-card-container">
                    <th:block th:each="device, iterStat : ${devices}">
                        <!-- 교실 헤더 표시 (새로운 교실일 때) -->
                        <div th:if="${iterStat.index == 0 or device.classroom?.roomName != devices[iterStat.index - 1].classroom?.roomName}" 
                             class="classroom-header-mobile">
                            <h3>
                                <i class="fas fa-door-open"></i> 
                                <span th:text="${device.classroom != null and device.classroom.roomName != null ? device.classroom.roomName : '미지정 교실'}"></span>
                            </h3>
                        </div>
                        
                        <!-- 세트타입 그룹 헤더 표시 (새로운 세트타입일 때) -->
                        <div th:if="${device.setType != null and !device.setType.isEmpty() and 
                                   (iterStat.index == 0 or 
                                    device.classroom?.roomName != devices[iterStat.index - 1].classroom?.roomName or
                                    device.setType != devices[iterStat.index - 1].setType)}" 
                             class="group-header-mobile">
                            <h4>
                                <i class="fas fa-layer-group"></i> 
                                세트: <span th:text="${device.setType}"></span>
                            </h4>
                        </div>
                        
                        <!-- 담당자 그룹 헤더 표시 (세트가 없고 새로운 담당자일 때) -->
                        <div th:if="${(device.setType == null or device.setType.isEmpty()) and 
                                   device.operator != null and device.operator.name != null and
                                   (iterStat.index == 0 or 
                                    device.classroom?.roomName != devices[iterStat.index - 1].classroom?.roomName or
                                    device.operator?.name != devices[iterStat.index - 1].operator?.name)}" 
                             class="group-header-mobile">
                            <h4>
                                <i class="fas fa-user"></i> 
                                담당자: <span th:text="${device.operator.name}"></span>
                                <span th:if="${device.operator.position != null}">
                                    (<span th:text="${device.operator.position}"></span>)
                                </span>
                            </h4>
                        </div>
                        
                        <!-- 장비 카드 -->
                        <div class="device-card">
                            <div class="card-header">
                                <div class="card-title" th:text="${device.type != null ? device.type : '장비'}">유형</div>
                                <div class="card-school" th:text="${device.school != null ? device.school.schoolName : '미지정'}">학교</div>
                            </div>
                            
                            <div class="card-content">
                                <div class="card-field">
                                    <div class="field-label">고유번호</div>
                                    <div class="field-value" th:if="${device.uid != null && device.uid.displayUid != null && !#strings.isEmpty(device.uid.displayUid)}" th:utext="${@deviceService.highlightSearchKeyword(device.uid.displayUid, searchKeyword)}"></div>
                                    <div class="field-value" th:if="${device.uid == null || device.uid.displayUid == null || #strings.isEmpty(device.uid.displayUid)}" style="color: #9ca3af;">-</div>
                                </div>
                                
                                <div class="card-field">
                                    <div class="field-label">관리번호</div>
                                    <div class="field-value" th:if="${device.manage != null && device.manage.displayId != null && !#strings.isEmpty(device.manage.displayId)}" th:text="${device.manage.displayId}"></div>
                                    <div class="field-value" th:if="${device.manage == null || device.manage.displayId == null || #strings.isEmpty(device.manage.displayId)}" style="color: #9ca3af;">-</div>
                                </div>
                                
                                <div class="card-field">
                                    <div class="field-label">직위</div>
                                    <div class="field-value" th:if="${device.operator != null && device.operator.position != null && !#strings.isEmpty(device.operator.position)}" th:text="${device.operator.position}"></div>
                                    <div class="field-value" th:if="${device.operator == null || device.operator.position == null || #strings.isEmpty(device.operator.position)}" style="color: #9ca3af;">-</div>
                                </div>
                                
                                <div class="card-field">
                                    <div class="field-label">담당자</div>
                                    <div class="field-value" th:if="${device.operator != null && device.operator.name != null && !#strings.isEmpty(device.operator.name)}" th:text="${device.operator.name}"></div>
                                    <div class="field-value" th:if="${device.operator == null || device.operator.name == null || #strings.isEmpty(device.operator.name)}" style="color: #9ca3af;">-</div>
                                </div>
                                
                                <div class="card-field">
                                    <div class="field-label">제조사</div>
                                    <div class="field-value" th:if="${device.manufacturer != null && !#strings.isEmpty(device.manufacturer)}" th:utext="${@deviceService.highlightSearchKeyword(device.manufacturer, searchKeyword)}"></div>
                                    <div class="field-value" th:if="${device.manufacturer == null || #strings.isEmpty(device.manufacturer)}" style="color: #9ca3af;">-</div>
                                </div>
                                
                                <div class="card-field">
                                    <div class="field-label">모델명</div>
                                    <div class="field-value" th:if="${device.modelName != null && !#strings.isEmpty(device.modelName)}" th:utext="${@deviceService.highlightSearchKeyword(device.modelName, searchKeyword)}"></div>
                                    <div class="field-value" th:if="${device.modelName == null || #strings.isEmpty(device.modelName)}" style="color: #9ca3af;">-</div>
                                </div>
                                
                                <div class="card-field">
                                    <div class="field-label">구매일자</div>
                                    <div class="field-value" th:if="${device.purchaseDate != null}" th:text="${#temporals.format(device.purchaseDate, 'yyyy년 MM월')}"></div>
                                    <div class="field-value" th:if="${device.purchaseDate == null}" style="color: #9ca3af;">-</div>
                                </div>
                                
                                <div class="card-field">
                                    <div class="field-label">IP주소</div>
                                    <div class="field-value" th:if="${device.ipAddress != null && !#strings.isEmpty(device.ipAddress)}" th:utext="${@deviceService.highlightSearchKeyword(device.ipAddress, searchKeyword)}"></div>
                                    <div class="field-value" th:if="${device.ipAddress == null || #strings.isEmpty(device.ipAddress)}" style="color: #9ca3af;">-</div>
                                </div>
                                
                                <div class="card-field">
                                    <div class="field-label">교실</div>
                                    <div class="field-value" th:if="${device.classroom != null && device.classroom.roomName != null && !#strings.isEmpty(device.classroom.roomName)}" th:text="${device.classroom.roomName}"></div>
                                    <div class="field-value" th:if="${device.classroom == null || device.classroom.roomName == null || #strings.isEmpty(device.classroom.roomName)}" style="color: #9ca3af;">-</div>
                                </div>
                                
                                <div class="card-field">
                                    <div class="field-label">용도</div>
                                    <div class="field-value" th:if="${device.purpose != null && !#strings.isEmpty(device.purpose)}" th:text="${device.purpose}"></div>
                                    <div class="field-value" th:if="${device.purpose == null || #strings.isEmpty(device.purpose)}" style="color: #9ca3af;">-</div>
                                </div>
                                
                                <div class="card-field">
                                    <div class="field-label">세트분류</div>
                                    <div class="field-value" th:if="${device.setType != null && !#strings.isEmpty(device.setType)}" th:text="${device.setType}"></div>
                                    <div class="field-value" th:if="${device.setType == null || #strings.isEmpty(device.setType)}" style="color: #9ca3af;">-</div>
                                </div>
                                
                                <div class="card-field">
                                    <div class="field-label">불용</div>
                                    <div class="field-value" th:if="${device.unused != null && device.unused}" style="color: #dc2626; font-weight: 600;">Y</div>
                                    <div class="field-value" th:if="${device.unused == null || !device.unused}" style="color: #16a34a; font-weight: 600;">N</div>
                                </div>
                                
                                <div class="card-field full-width">
                                    <div class="field-label">비고</div>
                                    <div class="field-value" th:if="${device.note != null && !#strings.isEmpty(device.note)}" th:text="${device.note}"></div>
                                    <div class="field-value" th:if="${device.note == null || #strings.isEmpty(device.note)}" style="color: #9ca3af;">-</div>
                                </div>
                            </div>
                            
                            <div class="card-actions">
                                <a th:href="@{/device/modify/{id}(id=${device.deviceId})}" class="btn btn-warning">
                                    <i class="fas fa-edit"></i> 수정
                                </a>
                                <form th:action="@{/device/remove}" method="post" style="display: inline;">
                                    <input type="hidden" name="device_id" th:value="${device.deviceId}">
                                    <button type="submit" class="btn btn-danger" onclick="return confirm('정말 삭제하시겠습니까?')">
                                        <i class="fas fa-trash-alt"></i> 삭제
                                    </button>
                                </form>
                                <!-- 검사확인 체크박스 (검사모드일 때만 표시) -->
                                <div th:if="${inspectionMode}" 
                                     th:classappend="${inspectionStatuses != null and inspectionStatuses.containsKey(device.deviceId) ? 
                                                      (inspectionStatuses.get(device.deviceId) == 'confirmed' ? 'state-confirmed' : 
                                                       (inspectionStatuses.get(device.deviceId) == 'modified' ? 'state-modified' : 'state-unchecked')) : 'state-unchecked'}" 
                                     class="inspection-checkbox-mobile" 
                                     th:data-device-id="${device.deviceId}" 
                                     onclick="toggleInspection(this)">
                                    <i th:if="${inspectionStatuses != null and inspectionStatuses.containsKey(device.deviceId) and inspectionStatuses.get(device.deviceId) == 'confirmed'}" 
                                       class="fas fa-check-circle inspection-icon confirmed" 
                                       style="color: #28a745;"></i>
                                    <i th:if="${inspectionStatuses != null and inspectionStatuses.containsKey(device.deviceId) and inspectionStatuses.get(device.deviceId) == 'modified'}" 
                                       class="fas fa-check-circle inspection-icon modified" 
                                       style="color: #ffc107;"></i>
                                    <i th:if="${inspectionStatuses == null or !inspectionStatuses.containsKey(device.deviceId) or inspectionStatuses.get(device.deviceId) == 'unchecked'}" 
                                       class="fas fa-check-circle inspection-icon unchecked" 
                                       style="color: #ccc;"></i>
                                    <span class="inspection-label">검사확인</span>
                                </div>
                            </div>
                        </div>
                    </th:block>
                </div>
                
                <!-- 페이징 네비게이션 -->
                <nav th:if="${totalPages > 1}">
                    <ul class="pagination">
                        <li th:classappend="${startPage == 1} ? 'disabled'">
                            <a th:if="${startPage != 1}" 
                               th:href="@{/device/list(
                                   page=${startPage - 1},
                                   schoolId=${selectedSchoolId != null ? selectedSchoolId : null},
                                   type=${selectedType != null and selectedType != '' ? selectedType : null},
                                   classroomId=${selectedClassroomId != null ? selectedClassroomId : null}
                               )}"
                               th:text="'이전'"></a>
                            <a th:if="${startPage == 1}" href="javascript:void(0);" th:text="'이전'"></a>
                        </li>
                        <li th:each="pageNum : ${#numbers.sequence(startPage, endPage)}">
                            <a th:href="@{/device/list(
                                   page=${pageNum},
                                   schoolId=${selectedSchoolId != null ? selectedSchoolId : null},
                                   type=${selectedType != null and selectedType != '' ? selectedType : null},
                                   classroomId=${selectedClassroomId != null ? selectedClassroomId : null}
                               )}"
                               th:text="${pageNum}"
                               th:classappend="${pageNum == currentPage} ? 'active'"></a>
                        </li>
                        <li th:classappend="${endPage == totalPages} ? 'disabled'">
                            <a th:if="${endPage != totalPages}" 
                               th:href="@{/device/list(
                                   page=${endPage + 1},
                                   schoolId=${selectedSchoolId != null ? selectedSchoolId : null},
                                   type=${selectedType != null and selectedType != '' ? selectedType : null},
                                   classroomId=${selectedClassroomId != null ? selectedClassroomId : null}
                               )}"
                               th:text="'다음'"></a>
                            <a th:if="${endPage == totalPages}" href="javascript:void(0);" th:text="'다음'"></a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
    
    <!-- 푸터 포함 -->
    <div th:replace="~{fragments/footer :: footer}"></div>
    
    <!-- 학교 선택 모달 -->
    <div id="schoolSelectModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>장비검사 - 학교 선택</h2>
            </div>
            <div class="modal-body">
                <div class="school-select">
                    <label for="schoolSelectDropdown">학교 선택:</label>
                    <select id="schoolSelectDropdown" class="form-select">
                        <option value="">학교를 선택하세요...</option>
                        <!-- 학교 목록이 여기에 동적으로 로드됩니다 -->
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button id="confirmSchoolSelect" class="confirm-btn">검사</button>
                <button id="cancelSchoolSelect" class="cancel-btn">취소</button>
            </div>
        </div>
    </div>
    
    <script>
        function updateClassrooms(schoolId) {
            const classroomSelect = document.getElementById('classroomSelect');
            const selectedClassroomId = classroomSelect.value; // 현재 선택된 교실 ID 저장
            classroomSelect.innerHTML = '<option value="">전체 교실</option>';
            
            if (schoolId) {
                fetch(`/device/api/classrooms/${schoolId}`)
                    .then(response => response.json())
                    .then(classrooms => {
                        classrooms.forEach(classroom => {
                            const option = document.createElement('option');
                            option.value = classroom.classroomId;
                            option.textContent = classroom.roomName;
                            if (classroom.classroomId == selectedClassroomId) {
                                option.selected = true;
                            }
                            classroomSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error:', error));
            } else {
                // 전체 학교일 때는 모든 교실 표시
                fetch('/device/api/classrooms')
                    .then(response => response.json())
                    .then(classrooms => {
                        classrooms.forEach(classroom => {
                            const option = document.createElement('option');
                            option.value = classroom.classroomId;
                            option.textContent = classroom.roomName;
                            if (classroom.classroomId == selectedClassroomId) {
                                option.selected = true;
                            }
                            classroomSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error:', error));
            }
        }
        
        // 교실 목록 업데이트 후 폼 제출
        function updateClassroomsAndSubmit(schoolId) {
            const classroomSelect = document.getElementById('classroomSelect');
            const selectedClassroomId = classroomSelect.value; // 현재 선택된 교실 ID 저장
            classroomSelect.innerHTML = '<option value="">전체 교실</option>';
            
            if (schoolId) {
                fetch(`/device/api/classrooms/${schoolId}`)
                    .then(response => response.json())
                    .then(classrooms => {
                        classrooms.forEach(classroom => {
                            const option = document.createElement('option');
                            option.value = classroom.classroomId;
                            option.textContent = classroom.roomName;
                            if (classroom.classroomId == selectedClassroomId) {
                                option.selected = true;
                            }
                            classroomSelect.appendChild(option);
                        });
                        // 교실 목록 업데이트 후 폼 제출
                        // hidden input에 현재 학교 ID 설정
                        document.getElementById('filterSchoolIdParam').value = schoolId;
                        document.getElementById('filterForm').submit();
                    })
                    .catch(error => console.error('Error:', error));
            } else {
                // 전체 학교일 때는 모든 교실 표시
                fetch('/device/api/classrooms')
                    .then(response => response.json())
                    .then(classrooms => {
                        classrooms.forEach(classroom => {
                            const option = document.createElement('option');
                            option.value = classroom.classroomId;
                            option.textContent = classroom.roomName;
                            if (classroom.classroomId == selectedClassroomId) {
                                option.selected = true;
                            }
                            classroomSelect.appendChild(option);
                        });
                        // 교실 목록 업데이트 후 폼 제출
                        // hidden input에 현재 학교 ID 설정 (전체 학교일 때는 빈 값)
                        document.getElementById('filterSchoolIdParam').value = '';
                        document.getElementById('filterForm').submit();
                    })
                    .catch(error => console.error('Error:', error));
            }
        }
        
        // 학교 ID 업데이트 후 폼 제출
        function updateSchoolIdAndSubmit() {
            const schoolSelect = document.getElementById('schoolSelect');
            const filterSchoolIdParam = document.getElementById('filterSchoolIdParam');
            
            if (schoolSelect && filterSchoolIdParam) {
                filterSchoolIdParam.value = schoolSelect.value;
            }
            
            document.getElementById('filterForm').submit();
        }

        // 학교 선택 이벤트
        document.getElementById('schoolSelect').addEventListener('change', function() {
            updateClassrooms(this.value);
            this.form.submit();
        });

        // 교실 선택 이벤트
        document.getElementById('classroomSelect').addEventListener('change', function() {
            this.form.submit();
        });

        // 검사모드 관련 변수
        let isInspectionMode = false;
        let selectedSchoolForInspection = null;
        let inspectionData = {}; // 장비별 검사 상태 저장

        // 페이지 로드 시 초기 교실 목록 설정
        document.addEventListener('DOMContentLoaded', function() {
            const schoolSelect = document.getElementById('schoolSelect');
            updateClassrooms(schoolSelect.value);
            
            // 검사 모드 확인 및 초기화
            const urlParams = new URLSearchParams(window.location.search);
            const inspectionMode = urlParams.get('inspectionMode');
            if (inspectionMode === 'true') {
                isInspectionMode = true;
                // DOM이 완전히 로드된 후 초기화 실행
                setTimeout(() => {
                    initializeInspectionMode();
                }, 100);
            }
            
            // 성공 메시지 자동 숨김 (5초 후)
            const successAlert = document.querySelector('.alert-success');
            if (successAlert) {
                setTimeout(() => {
                    successAlert.style.display = 'none';
                }, 5000);
            }
            
            // 로컬스토리지에서 체크박스 상태 복원 (QR코드는 이미 복원됨)
            loadCheckboxStates();
            
            // QR코드검색 체크박스 이벤트 (이미 체크된 상태 유지)
            const qrCodeSearchCheckbox = document.getElementById('qrCodeSearch');
            if (qrCodeSearchCheckbox) {
                qrCodeSearchCheckbox.addEventListener('change', function() {
                localStorage.setItem('qrCodeSearch', this.checked.toString());
            });
                // 이미 체크된 상태인지 확인하고 유지
                const savedQrCodeSearch = localStorage.getItem('qrCodeSearch');
                if (savedQrCodeSearch === 'true' && !qrCodeSearchCheckbox.checked) {
                    qrCodeSearchCheckbox.checked = true;
                }
            }
            
            // 장비가 있는 교실 체크박스 이벤트
            document.getElementById('showClassroomsWithDevices').addEventListener('change', function() {
                localStorage.setItem('showClassroomsWithDevices', this.checked.toString());
                filterDevicesByClassroom();
            });
            
            // 검색어 입력 이벤트는 제거 (타이핑할 때마다 폼 제출 방지)
        });
        
        // 체크박스 상태 로드 (페이지 로드 시에만)
        function loadCheckboxStates() {
            // localStorage에서 저장된 상태 복원
            const savedQrCodeSearch = localStorage.getItem('qrCodeSearch');
            const savedShowClassroomsWithDevices = localStorage.getItem('showClassroomsWithDevices');
            
            // QR코드검색 체크박스 상태 설정 (이미 복원되었을 수 있으므로 확인 후 설정)
            const qrCodeSearchCheckbox = document.getElementById('qrCodeSearch');
            if (qrCodeSearchCheckbox && savedQrCodeSearch !== null) {
                // 체크 상태가 다르면 업데이트
                const shouldBeChecked = savedQrCodeSearch === 'true';
                if (qrCodeSearchCheckbox.checked !== shouldBeChecked) {
                    qrCodeSearchCheckbox.checked = shouldBeChecked;
                }
            }
            
            // 장비가 있는 교실 체크박스 상태 설정
            const serverShowClassroomsWithDevices = /*[[${showClassroomsWithDevices}]]*/ false;
            const checkboxElement = document.getElementById('showClassroomsWithDevices');
            
            // 서버에서 값을 받은 경우 localStorage에 저장
            if (serverShowClassroomsWithDevices !== null && serverShowClassroomsWithDevices !== undefined) {
                localStorage.setItem('showClassroomsWithDevices', serverShowClassroomsWithDevices.toString());
            } else if (savedShowClassroomsWithDevices !== null) {
                // 서버 값이 없으면 localStorage에서 로드
                checkboxElement.checked = savedShowClassroomsWithDevices === 'true';
            }
            
            // 검색 폼과 필터 폼의 hidden input에도 체크박스 상태 설정
            const searchShowClassroomsInput = document.getElementById('searchShowClassroomsWithDevices');
            const filterShowClassroomsInput = document.getElementById('filterShowClassroomsWithDevices');
            const checkboxChecked = document.getElementById('showClassroomsWithDevices').checked;
            
            if (searchShowClassroomsInput) {
                searchShowClassroomsInput.value = checkboxChecked ? 'true' : '';
            }
            if (filterShowClassroomsInput) {
                filterShowClassroomsInput.value = checkboxChecked ? 'true' : '';
            }
            
            // 페이지 로드 시에는 서버에서 이미 필터링된 데이터를 받아왔으므로 클라이언트 필터링 불필요
            
            // 검사 모드가 아닐 때 inspectionMode 파라미터 제거
            if (!isInspectionMode) {
                document.getElementById('inspectionModeParam').value = '';
                document.getElementById('filterInspectionModeParam').value = '';
            }
        }
        
        // 교실별 장비 필터링 함수
        function filterDevicesByClassroom() {
            const searchKeyword = document.getElementById('searchInput').value.trim();
            const showClassroomsWithDevices = document.getElementById('showClassroomsWithDevices').checked;
            
            // 검사 모드인지 확인
            const isInspectionMode = /*[[${inspectionMode}]]*/ false;
            
            if (isInspectionMode) {
                // 검사 모드일 때는 필터 폼 사용
                const filterShowClassroomsInput = document.getElementById('filterShowClassroomsWithDevices');
                if (showClassroomsWithDevices) {
                    filterShowClassroomsInput.value = 'true';
                } else {
                    filterShowClassroomsInput.value = '';
                }
                document.getElementById('filterForm').submit();
            } else {
                // 일반 모드일 때는 검색 폼 사용
                const searchShowClassroomsInput = document.getElementById('searchShowClassroomsWithDevices');
                if (showClassroomsWithDevices) {
                    searchShowClassroomsInput.value = 'true';
                } else {
                    searchShowClassroomsInput.value = '';
                }
                document.getElementById('searchForm').submit();
            }
        }
        
        // 모든 장비 표시 함수
        function showAllDevices() {
            const deviceRows = document.querySelectorAll('tbody tr');
            deviceRows.forEach(row => {
                row.style.display = '';
            });
        }
        
        // 장비검사 모드 열기
        function openInspectionMode() {
            // 학교 목록 로드
            loadSchoolsForInspection();
            document.getElementById('schoolSelectModal').style.display = 'flex';
        }
        
        // 장비목록 열기
        function openDeviceList() {
            // 검사 모드에서 일반 장비 목록으로 돌아가기
            window.location.href = '/device/list';
        }
        
        // 학교 목록 로드
        function loadSchoolsForInspection() {
            fetch('/device/api/schools')
                .then(response => response.json())
                .then(schools => {
                    const schoolSelect = document.getElementById('schoolSelectDropdown');
                    schoolSelect.innerHTML = '<option value="">학교를 선택하세요...</option>';
                    
                    schools.forEach(school => {
                        const option = document.createElement('option');
                        option.value = school.schoolId;
                        option.textContent = school.schoolName;
                        schoolSelect.appendChild(option);
                    });
                    
                    // 학교 선택 이벤트
                    schoolSelect.addEventListener('change', function() {
                        selectedSchoolForInspection = this.value;
                    });
                })
                .catch(error => console.error('Error:', error));
        }
        
        // 학교 선택 모달 이벤트
        document.getElementById('cancelSchoolSelect').addEventListener('click', function() {
            document.getElementById('schoolSelectModal').style.display = 'none';
            selectedSchoolForInspection = null;
        });
        
        document.getElementById('confirmSchoolSelect').addEventListener('click', function() {
            if (!selectedSchoolForInspection) {
                alert('학교를 선택해주세요.');
                return;
            }
            
            // 검사모드 진입
            enterInspectionMode(selectedSchoolForInspection);
            document.getElementById('schoolSelectModal').style.display = 'none';
        });
        
        // 검사모드 진입
        function enterInspectionMode(schoolId) {
            isInspectionMode = true;
            
            // 학교 필터링을 위해 페이지 리로드
            const url = new URL(window.location);
            url.searchParams.set('schoolId', schoolId);
            url.searchParams.set('inspectionMode', 'true');
            window.location.href = url.toString();
        }
        
        // 검사모드 초기화
        function initializeInspectionMode() {
            // 검사 모드 파라미터 설정 (UI는 서버에서 이미 렌더링됨)
            const inspectionModeParam = document.getElementById('inspectionModeParam');
            const filterInspectionModeParam = document.getElementById('filterInspectionModeParam');
            if (inspectionModeParam) inspectionModeParam.value = 'true';
            if (filterInspectionModeParam) filterInspectionModeParam.value = 'true';
            
            // 검사 데이터 초기화
            inspectionData = {};
            
            // 저장된 검사 상태 로드
            loadInspectionStatuses();
        }
        
        // 저장된 검사 상태 로드
        function loadInspectionStatuses() {
            const urlParams = new URLSearchParams(window.location.search);
            const schoolId = urlParams.get('schoolId');
            
            console.log('검사 상태 로드 시작, schoolId:', schoolId);
            
            if (!schoolId) {
                console.error('학교 정보를 찾을 수 없습니다.');
                return;
            }
            
            fetch(`/device/inspection/status/load?schoolId=${schoolId}`)
                .then(response => response.json())
                .then(data => {
                    console.log('검사 상태 로드 응답:', data);
                    if (data.success && data.statuses) {
                        console.log('저장된 검사 상태들:', data.statuses);
                        
                        // DOM이 완전히 로드될 때까지 기다린 후 상태 복원 (카드 렌더링 대기)
                        let retryCount = 0;
                        const maxRetries = 10;
                        const retryInterval = 200;
                        
                        const tryApplyStatuses = () => {
                            const cardElements = document.querySelectorAll('.inspection-checkbox-mobile, .inspection-checkbox');
                            if (cardElements.length > 0 || retryCount >= maxRetries) {
                                console.log(`검사 상태 적용 시도 (재시도: ${retryCount}, 요소 수: ${cardElements.length})`);
                            applyInspectionStatuses(data.statuses);
                            } else {
                                retryCount++;
                                console.log(`검사 상태 적용 대기 중... (${retryCount}/${maxRetries})`);
                                setTimeout(tryApplyStatuses, retryInterval);
                            }
                        };
                        
                        setTimeout(tryApplyStatuses, 100);
                    } else {
                        console.log('저장된 검사 상태가 없습니다.');
                    }
                })
                .catch(error => {
                    console.error('검사 상태 로드 중 오류:', error);
                });
        }
        
        // 검사 상태를 UI에 적용
        function applyInspectionStatuses(statuses) {
            let restoredCount = 0;
            let notFoundCount = 0;
            
            Object.entries(statuses).forEach(([deviceId, status]) => {
                const element = document.querySelector(`[data-device-id="${deviceId}"]`);
                if (element) {
                    const icon = element.querySelector('.inspection-icon');
                    if (icon) {
                        inspectionData[deviceId] = status;
                        restoredCount++;
                        
                        console.log(`장비 ${deviceId} 상태 복원: ${status}`);
                        
                        // 아이콘 및 버튼 배경 상태 설정
                        switch(status) {
                            case 'confirmed':
                                icon.className = 'fas fa-check-circle inspection-icon confirmed';
                                icon.style.color = '#28a745';
                                break;
                            case 'modified':
                                icon.className = 'fas fa-check-circle inspection-icon modified';
                                icon.style.color = '#ffc107';
                                break;
                            case 'unchecked':
                            default:
                                icon.className = 'fas fa-check-circle inspection-icon unchecked';
                                icon.style.color = '#ccc';
                                break;
                        }
                        // 버튼 배경 상태 클래스 적용 (모바일/태블릿 카드 버튼)
                        element.classList.remove('state-unchecked', 'state-confirmed', 'state-modified');
                        element.classList.add('state-' + status);
                    } else {
                        console.warn(`장비 ${deviceId}의 아이콘 요소를 찾을 수 없습니다.`);
                        notFoundCount++;
                    }
                } else {
                    // DOM에 없는 장비는 현재 페이지에 표시되지 않는 장비이므로 정상적인 상황
                    notFoundCount++;
                }
            });
            
            console.log(`검사 상태 복원 완료: ${restoredCount}개 복원, ${notFoundCount}개는 현재 페이지에 없음`);
        }
        
        // 검사모드 종료
        function exitInspectionMode() {
            // 실시간 저장으로 인해 저장하지 않은 데이터가 없으므로 확인 메시지 제거
            
            isInspectionMode = false;
            
            // UI 복원
            document.getElementById('inspectionModeBtn').style.display = 'inline-block';
            document.getElementById('inspectionHistoryBtn').style.display = 'none';
            document.getElementById('inspectionColumn').style.display = 'none';
            document.getElementById('inspectionModeButtons').style.display = 'none';
            
            // 모든 검사확인 셀 숨기기
            document.querySelectorAll('#inspectionCell').forEach(cell => {
                cell.style.display = 'none';
            });
            
            // 학교 선택 활성화
            document.getElementById('schoolSelect').disabled = false;
            
            // 검사 데이터 초기화
            inspectionData = {};
        }
        
        // 검사 상태 토글
        function toggleInspection(element) {
            const deviceId = element.dataset.deviceId;
            const icon = element.querySelector('.inspection-icon');
            
            // 현재 상태 확인
            let currentState = inspectionData[deviceId] || 'unchecked';
            
            // 상태 변경
            switch(currentState) {
                case 'unchecked':
                    currentState = 'confirmed';
                    icon.className = 'fas fa-check-circle inspection-icon confirmed';
                    icon.style.color = '#28a745';
                    break;
                case 'confirmed':
                    currentState = 'modified';
                    icon.className = 'fas fa-check-circle inspection-icon modified';
                    icon.style.color = '#ffc107';
                    break;
                case 'modified':
                    currentState = 'unchecked';
                    icon.className = 'fas fa-check-circle inspection-icon unchecked';
                    icon.style.color = '#ccc';
                    break;
            }
            
            // 상태 저장
            inspectionData[deviceId] = currentState;
            // 버튼 배경 상태 클래스 적용 (모바일/태블릿 카드 버튼)
            element.classList.remove('state-unchecked', 'state-confirmed', 'state-modified');
            element.classList.add('state-' + currentState);
            
            // 실시간으로 서버에 저장
            saveInspectionStatusToServer(deviceId, currentState);
        }
        
        // 검사 상태를 서버에 저장
        function saveInspectionStatusToServer(deviceId, status) {
            const urlParams = new URLSearchParams(window.location.search);
            const currentSchoolId = urlParams.get('schoolId');
            
            console.log('검사 상태 저장 시작:', { deviceId, status, schoolId: currentSchoolId });
            
            if (!currentSchoolId) {
                console.error('학교 정보를 찾을 수 없습니다.');
                return;
            }
            
            fetch('/device/inspection/status/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    deviceId: deviceId,
                    schoolId: currentSchoolId,
                    status: status
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('검사 상태 저장 응답:', data);
                if (!data.success) {
                    console.error('검사 상태 저장 실패:', data.message);
                } else {
                    console.log('검사 상태 저장 성공');
                }
            })
            .catch(error => {
                console.error('검사 상태 저장 중 오류:', error);
            });
        }
        
        // 검사 저장 함수 제거 - 실시간 저장으로 대체됨
        
        // 검사 초기화
        function resetInspection() {
            if (!confirm('모든 검사 정보가 초기화됩니다. 정말 초기화하시겠습니까?')) {
                return;
            }
            
            console.log('검사 초기화 시작');
            
            // 모든 체크박스를 미확인 상태로 변경하고 서버에 저장 (데스크톱 + 모바일)
            const checkboxes = document.querySelectorAll('.inspection-checkbox, .inspection-checkbox-mobile');
            console.log(`초기화할 체크박스 개수: ${checkboxes.length}`);
            
            let resetCount = 0;
            checkboxes.forEach(checkbox => {
                const deviceId = checkbox.dataset.deviceId;
                const icon = checkbox.querySelector('.inspection-icon');
                
                if (deviceId && icon) {
                    // UI 업데이트
                    icon.className = 'fas fa-check-circle inspection-icon unchecked';
                    // 버튼 배경 상태 초기화
                    if (checkbox.classList) {
                        checkbox.classList.remove('state-confirmed','state-modified');
                        checkbox.classList.add('state-unchecked');
                    }
                    
                    // 검사 데이터 업데이트
                    inspectionData[deviceId] = 'unchecked';
                    
                    // 서버에 초기화 상태 저장
                    saveInspectionStatusToServer(deviceId, 'unchecked');
                    resetCount++;
                } else {
                    console.warn('체크박스에서 deviceId 또는 icon을 찾을 수 없습니다:', checkbox);
                }
            });
            
            console.log(`초기화 완료: ${resetCount}개 장비`);
            
            // 초기화 완료 메시지
            setTimeout(() => {
                alert('모든 검사 정보가 초기화되었습니다.');
            }, 500);
        }
        
        // QR코드검색 기능
        document.getElementById('searchInput').addEventListener('input', function() {
            const qrCodeSearch = document.getElementById('qrCodeSearch').checked;
            if (qrCodeSearch && this.value.trim() !== '') {
                // 즉시 검색 실행
                this.form.submit();
            }
        });
        
        // 엑셀 다운로드 (검사 데이터 포함)
        function downloadExcelWithInspection() {
            if (isInspectionMode) {
                // 검사모드인 경우 서버에서 검사 상태를 가져와서 엑셀 다운로드
                const schoolSelectElement = document.getElementById('schoolSelect');
                const schoolId = selectedSchoolForInspection || (schoolSelectElement ? schoolSelectElement.value : null);
                
                if (schoolId) {
                    // 서버에서 검사 상태를 가져와서 엑셀 다운로드
                    console.log('검사 상태 로드 시작, schoolId:', schoolId);
                    fetch(`/device/inspection/status/load?schoolId=${schoolId}`)
                        .then(response => response.json())
                        .then(inspectionStatuses => {
                            console.log('받은 검사 상태:', inspectionStatuses);
                            // 검사 상태가 있는 경우에만 검사 데이터를 포함한 엑셀 다운로드
                            if (Object.keys(inspectionStatuses).length > 0) {
                                console.log('검사 데이터를 포함한 엑셀 다운로드 시작');
                                const form = document.createElement('form');
                                form.method = 'POST';
                                form.action = '/device/excel/inspection';
                                
                                // 검사 데이터를 hidden input으로 추가
                                const inspectionDataInput = document.createElement('input');
                                inspectionDataInput.type = 'hidden';
                                inspectionDataInput.name = 'inspectionData';
                                inspectionDataInput.value = JSON.stringify(inspectionStatuses);
                                console.log('전송할 검사 데이터:', JSON.stringify(inspectionStatuses));
                                form.appendChild(inspectionDataInput);
                                
                                // 현재 필터 정보 추가
                                const schoolIdInput = document.createElement('input');
                                schoolIdInput.type = 'hidden';
                                schoolIdInput.name = 'schoolId';
                                schoolIdInput.value = schoolId;
                                form.appendChild(schoolIdInput);
                                
                                // 안전하게 DOM 요소 접근
                                const typeSelectElement = document.getElementById('typeSelect');
                                const typeInput = document.createElement('input');
                                typeInput.type = 'hidden';
                                typeInput.name = 'type';
                                typeInput.value = typeSelectElement ? typeSelectElement.value : '';
                                form.appendChild(typeInput);
                                
                                const classroomSelectElement = document.getElementById('classroomSelect');
                                const classroomIdInput = document.createElement('input');
                                classroomIdInput.type = 'hidden';
                                classroomIdInput.name = 'classroomId';
                                classroomIdInput.value = classroomSelectElement ? classroomSelectElement.value : '';
                                form.appendChild(classroomIdInput);
                                
                                document.body.appendChild(form);
                                form.submit();
                                document.body.removeChild(form);
                            } else {
                                // 검사 상태가 없는 경우 일반 엑셀 다운로드
                                const excelBtn = document.getElementById('excelDownloadBtn');
                                if (excelBtn && excelBtn.href) {
                                    window.location.href = excelBtn.href;
                                } else {
                                    // fallback: 직접 URL 구성
                                    window.location.href = '/device/excel';
                                }
                            }
                        })
                        .catch(error => {
                            console.error('검사 상태 로드 중 오류:', error);
                            // 오류 발생 시 일반 엑셀 다운로드
                            const excelBtn = document.getElementById('excelDownloadBtn');
                            if (excelBtn && excelBtn.href) {
                                window.location.href = excelBtn.href;
                            } else {
                                // fallback: 직접 URL 구성
                                window.location.href = '/device/excel';
                            }
                        });
                } else {
                    // 학교가 선택되지 않은 경우 일반 엑셀 다운로드
                    const excelBtn = document.getElementById('excelDownloadBtn');
                    if (excelBtn && excelBtn.href) {
                        window.location.href = excelBtn.href;
                    } else {
                        // fallback: 직접 URL 구성
                        window.location.href = '/device/excel';
                    }
                }
            } else {
                // 일반 모드인 경우 기존 방식 사용
                const excelBtn = document.getElementById('excelDownloadBtn');
                if (excelBtn && excelBtn.href) {
                    window.location.href = excelBtn.href;
                } else {
                    // fallback: 직접 URL 구성
                    window.location.href = '/device/excel';
                }
            }
        }
    </script>
</body>
</html> 