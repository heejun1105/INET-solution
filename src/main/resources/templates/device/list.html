<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>장비 목록</title>
    <link rel="stylesheet" href="/device.css" />
    <link rel="stylesheet" href="/main.css" />
    <link rel="stylesheet" href="/navbar.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        
        .alert-dismissible {
            position: relative;
        }
        
        .btn-close {
            position: absolute;
            top: 0;
            right: 0;
            z-index: 2;
            padding: 15px;
            background: transparent;
            border: 0;
            font-size: 20px;
            cursor: pointer;
            color: #155724;
        }
        
        .btn-close:hover {
            color: #0f5132;
        }
        
        .alert i {
            margin-right: 8px;
        }
        
        /* 검색 기능 스타일 */
        .search-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
            padding: 0 20px;
        }
        
        .search-form {
            width: 100%;
            max-width: 600px;
        }
        
        .search-input-group {
            display: flex;
            align-items: center;
            background: white;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .search-input-group:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        
        .search-input {
            flex: 1;
            padding: 15px 20px;
            border: none;
            outline: none;
            font-size: 16px;
            background: transparent;
        }
        
        .search-input::placeholder {
            color: #999;
            font-style: italic;
        }
        
        .search-btn {
            padding: 15px 20px;
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 16px;
        }
        
        .search-btn:hover {
            background: #0056b3;
        }
        
        .search-btn i {
            font-size: 18px;
        }
        
        /* 검색 키워드 강조 표시 스타일 */
        .search-highlight {
            background-color: transparent;
            color: #d32f2f;
            font-weight: bold;
            text-shadow: 0 0 1px rgba(255, 255, 255, 0.8);
        }
        
        .search-highlight:hover {
            color: #b71c1c;
            text-shadow: 0 0 2px rgba(255, 255, 255, 0.9);
            transition: all 0.2s ease;
        }
    </style>
</head>
<body>
    <!-- 네비게이션 바 포함 -->
    <div th:replace="~{fragments/navbar :: navbar}"></div>
    
    <div class="container">
        <div class="device-list-container">
            <!-- 성공 메시지 표시 -->
            <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle"></i>
                <span th:text="${successMessage}"></span>
                <button type="button" class="btn-close" onclick="this.parentElement.style.display='none'"></button>
            </div>
            
            <div class="title">
                <div class="subject">장비 목록</div>
                <div class="subtitle">학교별, 유형별로 장비를 관리하세요!</div>
            </div>
            
            <!-- 검색 기능 -->
            <div class="search-container">
                <form th:action="@{/device/list}" method="get" class="search-form">
                    <input type="hidden" name="schoolId" th:value="${selectedSchoolId}" />
                    <input type="hidden" name="classroomId" th:value="${selectedClassroomId}" />
                    <input type="hidden" name="type" th:value="${selectedType}" />
                    <input type="hidden" name="page" value="1" />
                    <input type="hidden" name="size" th:value="${pageSize}" />
                    
                    <div class="search-input-group">
                        <input type="text" name="searchKeyword" 
                               th:value="${searchKeyword}" 
                               placeholder="모델명, 제조사, IP주소, 고유번호로 검색" 
                               class="search-input" />
                        <button type="submit" class="search-btn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </form>
            </div>
            <div class="main">
                <div class="filter-container">
                    <form th:action="@{/device/list}" method="get" class="d-flex align-items-center">
                        <select name="schoolId" id="schoolSelect" onchange="updateClassrooms(this.value)">
                            <option value="">전체 학교</option>
                            <option th:each="school : ${schools}" 
                                    th:value="${school.schoolId}"
                                    th:text="${school.schoolName}"
                                    th:selected="${selectedSchoolId} == ${school.schoolId}">
                            </option>
                        </select>
                        <select name="classroomId" id="classroomSelect">
                            <option value="">전체 교실</option>
                            <option th:each="classroom : ${classrooms}" 
                                    th:value="${classroom.classroomId}"
                                    th:text="${classroom.roomName}"
                                    th:selected="${selectedClassroomId} == ${classroom.classroomId}">
                            </option>
                        </select>
                        <select name="type" onchange="this.form.submit()">
                            <option value="">전체 유형</option>
                            <option th:each="t : ${types}"
                                    th:value="${t}"
                                    th:text="${t}"
                                    th:selected="${selectedType} == ${t}">
                            </option>
                        </select>
                        <input type="hidden" name="page" value="1" />
                        <input type="hidden" name="size" th:value="${pageSize}" />
                    </form>
                    <div class="action-buttons-container">
                        <a href="/device/register" class="btn btn-primary">
                            <i class="fas fa-plus-circle"></i> 장비 등록
                        </a>
                        <a th:href="@{/device/excel(schoolId=${selectedSchoolId}, type=${selectedType}, classroomId=${selectedClassroomId})}" class="btn btn-success">
                            <i class="fas fa-file-excel"></i> 엑셀 다운로드
                        </a>
                        <a th:href="@{/device/history/list(schoolId=${selectedSchoolId})}" class="btn btn-info">
                            <i class="fas fa-history"></i> 수정내역
                        </a>
                    </div>
                </div>
                
                <!-- 데스크톱 테이블 뷰 -->
                <table class="device-table">
                    <thead>
                        <tr>
                            <th>학교</th>
                            <th>고유번호</th>
                            <th>관리번호</th>
                            <th>유형</th>
                            <th>직위</th>
                            <th>담당자</th>
                            <th>제조사</th>
                            <th>모델명</th>
                            <th>도입일자</th>
                            <th>IP주소</th>
                            <th>교실</th>
                            <th>용도</th>
                            <th>set분류</th>
                            <th>비고</th>
                            <th>불용</th>
                            <th>관리</th>
                        </tr>
                    </thead>
                    <tbody>
                        <th:block th:each="device, iterStat : ${devices}">
                            <!-- 교실 헤더 표시 (새로운 교실일 때) -->
                            <tr th:if="${iterStat.index == 0 or device.classroom?.roomName != devices[iterStat.index - 1].classroom?.roomName}" 
                                class="classroom-header">
                                <td colspan="16">
                                    <strong>
                                        <i class="fas fa-door-open"></i> 
                                        <span th:text="${device.classroom != null and device.classroom.roomName != null ? device.classroom.roomName : '미지정 교실'}"></span>
                                    </strong>
                                </td>
                            </tr>
                            
                            <!-- 세트타입 그룹 헤더 표시 (새로운 세트타입일 때) -->
                            <tr th:if="${device.setType != null and !device.setType.isEmpty() and 
                                       (iterStat.index == 0 or 
                                        device.classroom?.roomName != devices[iterStat.index - 1].classroom?.roomName or
                                        device.setType != devices[iterStat.index - 1].setType)}" 
                                class="group-header">
                                <td colspan="16">
                                    <strong>
                                        <i class="fas fa-layer-group"></i> 
                                        세트: <span th:text="${device.setType}"></span>
                                    </strong>
                                </td>
                            </tr>
                            
                            <!-- 담당자 그룹 헤더 표시 (세트가 없고 새로운 담당자일 때) -->
                            <tr th:if="${(device.setType == null or device.setType.isEmpty()) and 
                                       device.operator != null and device.operator.name != null and
                                       (iterStat.index == 0 or 
                                        device.classroom?.roomName != devices[iterStat.index - 1].classroom?.roomName or
                                        device.operator?.name != devices[iterStat.index - 1].operator?.name)}" 
                                class="group-header">
                                <td colspan="16">
                                    <strong>
                                        <i class="fas fa-user"></i> 
                                        담당자: <span th:text="${device.operator.name}"></span>
                                        <span th:if="${device.operator.position != null}">
                                            (<span th:text="${device.operator.position}"></span>)
                                        </span>
                                    </strong>
                                </td>
                            </tr>
                            
                            <!-- 장비 데이터 행 -->
                            <tr th:class="${device.setType != null and !device.setType.isEmpty() ? 'set-group-item' : 'operator-group-item'}">
                                <td data-label="학교" th:text="${device.school != null ? device.school.schoolName : '미지정'}"></td>
                                <td data-label="고유번호" th:utext="${device.uid != null ? @deviceService.highlightSearchKeyword(device.uid.displayUid, searchKeyword) : ''}"></td>
                                <td data-label="관리번호" th:text="${device.manage != null ? device.manage.displayId : ''}"></td>
                                <td data-label="유형" class="device-type" th:text="${device.type != null ? device.type : ''}"></td>
                                <td data-label="직위" th:text="${device.operator != null && device.operator.position != null ? device.operator.position : ''}"></td>
                                <td data-label="담당자" th:text="${device.operator != null && device.operator.name != null ? device.operator.name : ''}"></td>
                                <td data-label="제조사" th:utext="${device.manufacturer != null ? @deviceService.highlightSearchKeyword(device.manufacturer, searchKeyword) : ''}"></td>
                                <td data-label="모델명" th:utext="${device.modelName != null ? @deviceService.highlightSearchKeyword(device.modelName, searchKeyword) : ''}"></td>
                                <td data-label="구매일자" th:text="${device.purchaseDate != null ? #temporals.format(device.purchaseDate, 'yyyy년 MM월') : ''}"></td>
                                <td data-label="IP주소" class="ip-address" th:utext="${device.ipAddress != null ? @deviceService.highlightSearchKeyword(device.ipAddress, searchKeyword) : ''}"></td>
                                <td data-label="교실" th:text="${device.classroom != null && device.classroom.roomName != null ? device.classroom.roomName : ''}"></td>
                                <td data-label="용도" th:text="${device.purpose != null ? device.purpose : ''}"></td>
                                <td data-label="세트분류" th:text="${device.setType != null ? device.setType : ''}"></td>
                                <td data-label="비고" th:text="${device.note != null ? device.note : ''}"></td>
                                <td data-label="불용" th:text="${device.unused != null && device.unused ? 'Y' : 'N'}"></td>
                                <td data-label="관리">
                                    <div class="action-buttons">
                                        <a th:href="@{/device/modify/{id}(id=${device.deviceId})}" class="btn btn-warning">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <form th:action="@{/device/remove}" method="post" style="display: inline;">
                                            <input type="hidden" name="device_id" th:value="${device.deviceId}">
                                            <button type="submit" class="btn btn-danger" onclick="return confirm('정말 삭제하시겠습니까?')">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        </th:block>
                    </tbody>
                </table>
                
                <!-- 모바일 카드 뷰 -->
                <div class="mobile-card-container">
                    <th:block th:each="device, iterStat : ${devices}">
                        <!-- 교실 헤더 표시 (새로운 교실일 때) -->
                        <div th:if="${iterStat.index == 0 or device.classroom?.roomName != devices[iterStat.index - 1].classroom?.roomName}" 
                             class="classroom-header-mobile">
                            <h3>
                                <i class="fas fa-door-open"></i> 
                                <span th:text="${device.classroom != null and device.classroom.roomName != null ? device.classroom.roomName : '미지정 교실'}"></span>
                            </h3>
                        </div>
                        
                        <!-- 세트타입 그룹 헤더 표시 (새로운 세트타입일 때) -->
                        <div th:if="${device.setType != null and !device.setType.isEmpty() and 
                                   (iterStat.index == 0 or 
                                    device.classroom?.roomName != devices[iterStat.index - 1].classroom?.roomName or
                                    device.setType != devices[iterStat.index - 1].setType)}" 
                             class="group-header-mobile">
                            <h4>
                                <i class="fas fa-layer-group"></i> 
                                세트: <span th:text="${device.setType}"></span>
                            </h4>
                        </div>
                        
                        <!-- 담당자 그룹 헤더 표시 (세트가 없고 새로운 담당자일 때) -->
                        <div th:if="${(device.setType == null or device.setType.isEmpty()) and 
                                   device.operator != null and device.operator.name != null and
                                   (iterStat.index == 0 or 
                                    device.classroom?.roomName != devices[iterStat.index - 1].classroom?.roomName or
                                    device.operator?.name != devices[iterStat.index - 1].operator?.name)}" 
                             class="group-header-mobile">
                            <h4>
                                <i class="fas fa-user"></i> 
                                담당자: <span th:text="${device.operator.name}"></span>
                                <span th:if="${device.operator.position != null}">
                                    (<span th:text="${device.operator.position}"></span>)
                                </span>
                            </h4>
                        </div>
                        
                        <!-- 장비 카드 -->
                        <div class="device-card">
                            <div class="card-header">
                                <div class="card-title" th:text="${device.type != null ? device.type : '장비'}">유형</div>
                                <div class="card-school" th:text="${device.school != null ? device.school.schoolName : '미지정'}">학교</div>
                            </div>
                            
                            <div class="card-content">
                                <div class="card-field" th:if="${device.uid != null && device.uid.displayUid != null && !#strings.isEmpty(device.uid.displayUid)}">
                                    <div class="field-label">고유번호</div>
                                    <div class="field-value" th:utext="${@deviceService.highlightSearchKeyword(device.uid.displayUid, searchKeyword)}"></div>
                                </div>
                                
                                <div class="card-field" th:if="${device.manage != null && device.manage.displayId != null && !#strings.isEmpty(device.manage.displayId)}">
                                    <div class="field-label">관리번호</div>
                                    <div class="field-value" th:text="${device.manage.displayId}"></div>
                                </div>
                                
                                <div class="card-field" th:if="${device.operator != null && device.operator.position != null && !#strings.isEmpty(device.operator.position)}">
                                    <div class="field-label">직위</div>
                                    <div class="field-value" th:text="${device.operator.position}"></div>
                                </div>
                                
                                <div class="card-field" th:if="${device.operator != null && device.operator.name != null && !#strings.isEmpty(device.operator.name)}">
                                    <div class="field-label">담당자</div>
                                    <div class="field-value" th:text="${device.operator.name}"></div>
                                </div>
                                
                                <div class="card-field" th:if="${device.manufacturer != null && !#strings.isEmpty(device.manufacturer)}">
                                    <div class="field-label">제조사</div>
                                    <div class="field-value" th:utext="${@deviceService.highlightSearchKeyword(device.manufacturer, searchKeyword)}"></div>
                                </div>
                                
                                <div class="card-field full-width" th:if="${device.modelName != null && !#strings.isEmpty(device.modelName)}">
                                    <div class="field-label">모델명</div>
                                    <div class="field-value" th:utext="${@deviceService.highlightSearchKeyword(device.modelName, searchKeyword)}"></div>
                                </div>
                                
                                <div class="card-field" th:if="${device.purchaseDate != null}">
                                    <div class="field-label">구매일자</div>
                                    <div class="field-value" th:text="${#temporals.format(device.purchaseDate, 'yyyy년 MM월')}"></div>
                                </div>
                                
                                <div class="card-field" th:if="${device.ipAddress != null && !#strings.isEmpty(device.ipAddress)}">
                                    <div class="field-label">IP주소</div>
                                    <div class="field-value" th:utext="${@deviceService.highlightSearchKeyword(device.ipAddress, searchKeyword)}"></div>
                                </div>
                                
                                <div class="card-field" th:if="${device.classroom != null && device.classroom.roomName != null && !#strings.isEmpty(device.classroom.roomName)}">
                                    <div class="field-label">교실</div>
                                    <div class="field-value" th:text="${device.classroom.roomName}"></div>
                                </div>
                                
                                <div class="card-field" th:if="${device.purpose != null && !#strings.isEmpty(device.purpose)}">
                                    <div class="field-label">용도</div>
                                    <div class="field-value" th:text="${device.purpose}"></div>
                                </div>
                                
                                <div class="card-field" th:if="${device.setType != null && !#strings.isEmpty(device.setType)}">
                                    <div class="field-label">세트분류</div>
                                    <div class="field-value" th:text="${device.setType}"></div>
                                </div>
                                
                                <div class="card-field" th:if="${device.unused != null && device.unused}">
                                    <div class="field-label">불용</div>
                                    <div class="field-value" style="color: #dc2626; font-weight: 600;">Y</div>
                                </div>
                                
                                <div class="card-field full-width" th:if="${device.note != null && !#strings.isEmpty(device.note)}">
                                    <div class="field-label">비고</div>
                                    <div class="field-value" th:text="${device.note}"></div>
                                </div>
                            </div>
                            
                            <div class="card-actions">
                                <a th:href="@{/device/modify/{id}(id=${device.deviceId})}" class="btn btn-warning">
                                    <i class="fas fa-edit"></i> 수정
                                </a>
                                <form th:action="@{/device/remove}" method="post" style="display: inline;">
                                    <input type="hidden" name="device_id" th:value="${device.deviceId}">
                                    <button type="submit" class="btn btn-danger" onclick="return confirm('정말 삭제하시겠습니까?')">
                                        <i class="fas fa-trash-alt"></i> 삭제
                                    </button>
                                </form>
                            </div>
                        </div>
                    </th:block>
                </div>
                
                <!-- 페이징 네비게이션 -->
                <nav th:if="${totalPages > 1}">
                    <ul class="pagination">
                        <li th:classappend="${startPage == 1} ? 'disabled'">
                            <a th:if="${startPage != 1}" 
                               th:href="@{/device/list(
                                   page=${startPage - 1},
                                   schoolId=${selectedSchoolId != null ? selectedSchoolId : null},
                                   type=${selectedType != null and selectedType != '' ? selectedType : null},
                                   classroomId=${selectedClassroomId != null ? selectedClassroomId : null}
                               )}"
                               th:text="'이전'"></a>
                            <a th:if="${startPage == 1}" href="javascript:void(0);" th:text="'이전'"></a>
                        </li>
                        <li th:each="pageNum : ${#numbers.sequence(startPage, endPage)}">
                            <a th:href="@{/device/list(
                                   page=${pageNum},
                                   schoolId=${selectedSchoolId != null ? selectedSchoolId : null},
                                   type=${selectedType != null and selectedType != '' ? selectedType : null},
                                   classroomId=${selectedClassroomId != null ? selectedClassroomId : null}
                               )}"
                               th:text="${pageNum}"
                               th:classappend="${pageNum == currentPage} ? 'active'"></a>
                        </li>
                        <li th:classappend="${endPage == totalPages} ? 'disabled'">
                            <a th:if="${endPage != totalPages}" 
                               th:href="@{/device/list(
                                   page=${endPage + 1},
                                   schoolId=${selectedSchoolId != null ? selectedSchoolId : null},
                                   type=${selectedType != null and selectedType != '' ? selectedType : null},
                                   classroomId=${selectedClassroomId != null ? selectedClassroomId : null}
                               )}"
                               th:text="'다음'"></a>
                            <a th:if="${endPage == totalPages}" href="javascript:void(0);" th:text="'다음'"></a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
    
    <!-- 푸터 포함 -->
    <div th:replace="~{fragments/footer :: footer}"></div>
    
    <script>
        function updateClassrooms(schoolId) {
            const classroomSelect = document.getElementById('classroomSelect');
            const selectedClassroomId = classroomSelect.value; // 현재 선택된 교실 ID 저장
            classroomSelect.innerHTML = '<option value="">전체 교실</option>';
            
            if (schoolId) {
                fetch(`/device/api/classrooms/${schoolId}`)
                    .then(response => response.json())
                    .then(classrooms => {
                        classrooms.forEach(classroom => {
                            const option = document.createElement('option');
                            option.value = classroom.classroomId;
                            option.textContent = classroom.roomName;
                            if (classroom.classroomId == selectedClassroomId) {
                                option.selected = true;
                            }
                            classroomSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error:', error));
            } else {
                // 전체 학교일 때는 모든 교실 표시
                fetch('/device/api/classrooms')
                    .then(response => response.json())
                    .then(classrooms => {
                        classrooms.forEach(classroom => {
                            const option = document.createElement('option');
                            option.value = classroom.classroomId;
                            option.textContent = classroom.roomName;
                            if (classroom.classroomId == selectedClassroomId) {
                                option.selected = true;
                            }
                            classroomSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error:', error));
            }
        }

        // 학교 선택 이벤트
        document.getElementById('schoolSelect').addEventListener('change', function() {
            updateClassrooms(this.value);
            this.form.submit();
        });

        // 교실 선택 이벤트
        document.getElementById('classroomSelect').addEventListener('change', function() {
            this.form.submit();
        });

        // 페이지 로드 시 초기 교실 목록 설정
        document.addEventListener('DOMContentLoaded', function() {
            const schoolSelect = document.getElementById('schoolSelect');
            updateClassrooms(schoolSelect.value);
            
            // 성공 메시지 자동 숨김 (5초 후)
            const successAlert = document.querySelector('.alert-success');
            if (successAlert) {
                setTimeout(() => {
                    successAlert.style.display = 'none';
                }, 5000);
            }
        });
    </script>
</body>
</html> 