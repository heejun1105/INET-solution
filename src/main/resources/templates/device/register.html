<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>장비 등록</title>
    <link rel="stylesheet" href="/device.css">
    <link rel="stylesheet" href="/main.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- 네비게이션 바 포함 -->
    <div th:replace="~{fragments/navbar :: navbar}"></div>
    
    <div class="container">
        <div class="device-form-container">
            <div class="title">
                <div class="subject">장비 등록</div>
                <div class="subtitle">새로운 장비 정보를 입력해 주세요.</div>
                <div style="margin-top:10px;">
                    <a href="/device/upload" class="sub-but" style="background-color:#28a745; color:white; padding:6px 16px; border-radius:4px; text-decoration:none;">
                        <i class="fas fa-file-excel"></i> 엑셀 업로드
                    </a>
                </div>
            </div>
            <div class="main">
                <form id="deviceForm" th:action="@{/device/register}" th:object="${device}" method="post">
                    
                    <!-- 기본 정보 섹션 -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3><i class="fas fa-info-circle"></i> 기본 정보</h3>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="required">학교</label>
                                <select name="school" th:field="*{school}" required>
                                    <option th:each="school : ${schools}" 
                                            th:value="${school.schoolId}" 
                                            th:text="${school.schoolName}">
                                    </option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="required">유형</label>
                                <select id="typeSelect" name="type" th:field="*{type}" required>
                                    <option value="">유형 선택</option>
                                    <option th:each="type : ${types}" 
                                            th:value="${type}" 
                                            th:text="${type}">
                                    </option>
                                    <option value="CUSTOM">직접입력</option>
                                </select>
                                <input type="text" id="typeInput" name="typeCustom" placeholder="직접 입력" style="display:none; margin-top: 8px;" th:field="*{type}">
                            </div>

                            <div class="form-group full-width">
                                <label class="required">고유번호</label>
                                <div style="display: flex; gap: 8px;">
                                    <select id="uidCate" name="uidCate" required>
                                        <option value="">구분 선택</option>
                                        <option value="custom">직접입력</option>
                                    </select>
                                    <input type="text" id="uidCateInput" name="uidCateCustom" placeholder="구분 직접입력" style="display:none; width: 80px;">

                                    <select id="uidYear" name="uidYear" required>
                                        <option value="">연도 선택</option>
                                        <option value="custom">직접입력</option>
                                    </select>
                                    <input type="text" id="uidYearInput" name="uidYearCustom" placeholder="연도 직접입력" style="display:none; width: 60px;">

                                    <select id="uidNum" name="uidNum" required>
                                        <option value="">번호 선택</option>
                                        <option value="custom">직접입력</option>
                                    </select>
                                    <input type="number" id="uidNumInput" name="uidNumCustom" placeholder="번호 직접입력" style="display:none; width: 60px;">
                                </div>
                            </div>

                            <div class="form-group full-width">
                                <label class="required">관리번호</label>
                                <div style="display: flex; gap: 8px;">
                                    <select id="manageCate" name="manageCate" required>
                                        <option value="">구분 선택</option>
                                        <option value="custom">직접입력</option>
                                    </select>
                                    <input type="text" id="manageCateInput" name="manageCateCustom" placeholder="구분 직접입력" style="display:none; width: 80px;">

                                    <select id="manageYear" name="manageYear" required>
                                        <option value="">연도 선택</option>
                                        <option value="custom">직접입력</option>
                                    </select>
                                    <input type="text" id="manageYearInput" name="manageYearCustom" placeholder="연도 직접입력" style="display:none; width: 60px;">

                                    <select id="manageNum" name="manageNum" required>
                                        <option value="">번호 선택</option>
                                        <option value="custom">직접입력</option>
                                    </select>
                                    <input type="number" id="manageNumInput" name="manageNumCustom" placeholder="번호 직접입력" style="display:none; width: 60px;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 장비 상세 섹션 -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3><i class="fas fa-cogs"></i> 장비 상세</h3>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>제조사</label>
                                <input type="text" th:field="*{manufacturer}">
                            </div>

                            <div class="form-group">
                                <label>모델명</label>
                                <input type="text" th:field="*{modelName}">
                            </div>

                            <div class="form-group">
                                <label>구매일자</label>
                                <input type="date" th:field="*{purchaseDate}">
                            </div>

                            <div class="form-group">
                                <label>불용 여부</label>
                                <div class="gender">
                                    <label><input type="checkbox" th:field="*{unused}">불용</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 위치 정보 섹션 -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3><i class="fas fa-map-marker-alt"></i> 위치 정보</h3>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>IP주소</label>
                                <input type="text" th:field="*{ipAddress}">
                            </div>

                            <div class="form-group">
                                <label class="required">위치</label>
                                <input type="text" name="location" required>
                                <div class="form-help">교실 또는 설치 장소를 입력하세요.</div>
                            </div>
                        </div>
                    </div>

                    <!-- 관리 정보 섹션 -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3><i class="fas fa-clipboard-list"></i> 관리 정보</h3>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>용도</label>
                                <input type="text" th:field="*{purpose}">
                            </div>

                            <div class="form-group">
                                <label>세트분류</label>
                                <input type="text" th:field="*{setType}">
                            </div>

                            <div class="form-group">
                                <label>담당자</label>
                                <input type="text" name="operatorName">
                            </div>

                            <div class="form-group">
                                <label>직위</label>
                                <input type="text" name="operatorPosition">
                            </div>

                            <div class="form-group full-width">
                                <label>비고</label>
                                <textarea th:field="*{note}" rows="3"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="form-buttons">
                        <button type="submit" class="sub-but">등록</button>
                        <a href="/device/list" class="sub-but" style="background-color: #6c757d;">목록</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 푸터 포함 -->
    <div th:replace="~{fragments/footer :: footer}"></div>
    
    <script>
        // 학교 선택 시 관리번호 카테고리 로드
        function loadManageCates(schoolId) {
            console.log('=== loadManageCates 함수 호출 ===');
            console.log('전달받은 schoolId:', schoolId);
            console.log('schoolId 타입:', typeof schoolId);
            
            const apiUrl = `/api/manages/cates/${schoolId}`;
            console.log('호출할 API URL:', apiUrl);
            
            fetch(apiUrl)
                .then(response => {
                    console.log('=== API 응답 받음 ===');
                    console.log('응답 상태:', response.status);
                    console.log('응답 OK:', response.ok);
                    console.log('응답 헤더:', response.headers);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(cates => {
                    console.log('=== JSON 파싱 성공 ===');
                    console.log('받은 카테고리 목록:', cates);
                    console.log('카테고리 개수:', cates.length);
                    console.log('카테고리 타입:', typeof cates);
                    
                    const cateSelect = document.getElementById('manageCate');
                    console.log('manageCate select 요소:', cateSelect);
                    
                    cateSelect.innerHTML = '<option value="">구분 선택</option>';
                    
                    cates.forEach((cate, index) => {
                        console.log(`카테고리 ${index}:`, cate);
                        const option = document.createElement('option');
                        option.value = cate;
                        option.textContent = cate;
                        cateSelect.appendChild(option);
                    });
                    
                    const customOption = document.createElement('option');
                    customOption.value = 'custom';
                    customOption.textContent = '직접입력';
                    cateSelect.appendChild(customOption);
                    
                    console.log('카테고리 옵션 추가 완료');
                })
                .catch(error => {
                    console.error('=== API 호출 오류 ===');
                    console.error('오류 타입:', error.name);
                    console.error('오류 메시지:', error.message);
                    console.error('전체 오류:', error);
                });
        }

        // 관리번호 카테고리 선택 시 연도 로드
        function loadYears(schoolId, manageCate) {
            if (manageCate === 'custom') return;
            fetch(`/api/manages/years/${schoolId}/${encodeURIComponent(manageCate)}`)
                .then(response => response.json())
                .then(years => {
                    const yearSelect = document.getElementById('manageYear');
                    yearSelect.innerHTML = '<option value="">연도 선택</option>';
                    years.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        yearSelect.appendChild(option);
                    });
                    const customOption = document.createElement('option');
                    customOption.value = 'custom';
                    customOption.textContent = '직접입력';
                    yearSelect.appendChild(customOption);
                });
        }

        // 연도 선택 시 번호 목록 로드
        function loadManageNums(schoolId, manageCate, year) {
            if (manageCate === 'custom') return;
            
            let url = `/api/manages/nums/${schoolId}/${encodeURIComponent(manageCate)}`;
            if (year && year !== 'custom') {
                url = `/api/manages/nums/${schoolId}/${encodeURIComponent(manageCate)}?year=${year}`;
            }
            
            console.log('번호 로드 API 호출:', url);
            
            fetch(url)
                .then(response => response.json())
                .then(nums => {
                    console.log('받은 번호 목록:', nums);
                    const numSelect = document.getElementById('manageNum');
                    numSelect.innerHTML = '<option value="">번호 선택</option>';
                    
                    if (nums && nums.length > 0) {
                        // 마지막 번호+1만 표시
                        const sortedNums = nums.sort((a, b) => a - b);
                        const lastNum = sortedNums[sortedNums.length - 1]; // 마지막 번호 (신규)
                        
                        const option = document.createElement('option');
                        option.value = lastNum;
                        option.textContent = lastNum + ' (신규)';
                        option.selected = true; // 기본 선택
                        numSelect.appendChild(option);
                    } else {
                        // 번호가 없는 경우 1번을 신규로 추가
                        const option = document.createElement('option');
                        option.value = 1;
                        option.textContent = '1 (신규)';
                        option.selected = true;
                        numSelect.appendChild(option);
                    }
                    
                    const customOption = document.createElement('option');
                    customOption.value = 'custom';
                    customOption.textContent = '직접입력';
                    numSelect.appendChild(customOption);
                })
                .catch(error => {
                    console.error('번호 로드 중 오류:', error);
                });
        }

        // 고유번호 관련 함수들

        // 고유번호 카테고리 로드
        function loadUidCates(schoolId) {
            console.log('=== 고유번호 카테고리 로드 시작 ===');
            console.log('학교 ID:', schoolId);
            
            fetch(`/api/uids/cates/${schoolId}`)
                .then(response => {
                    console.log('API 응답 상태:', response.status);
                    if (response.status === 404) {
                        console.log('해당 학교의 고유번호 카테고리 데이터가 없습니다.');
                        return ["DW", "MO", "PR", "TV", "ID", "ED", "DI", "TB", "PJ", "ET"]; // 기본 카테고리
                    }
                    return response.json();
                })
                .then(cates => {
                    console.log('받은 고유번호 카테고리 목록:', cates);
                    const cateSelect = document.getElementById('uidCate');
                    cateSelect.innerHTML = '<option value="">구분 선택</option>';
                    
                    // cates가 배열인지 확인
                    if (Array.isArray(cates)) {
                        cates.forEach((cate, index) => {
                            console.log(`고유번호 카테고리 ${index}:`, cate);
                            const option = document.createElement('option');
                            option.value = cate;
                            option.textContent = cate;
                            cateSelect.appendChild(option);
                        });
                    }
                    
                    const customOption = document.createElement('option');
                    customOption.value = 'custom';
                    customOption.textContent = '직접입력';
                    cateSelect.appendChild(customOption);
                    
                    console.log('고유번호 카테고리 옵션 추가 완료');
                })
                .catch(error => {
                    console.error('=== 고유번호 카테고리 API 호출 오류 ===');
                    console.error('오류 타입:', error.name);
                    console.error('오류 메시지:', error.message);
                    console.error('전체 오류:', error);
                    
                    // 오류 발생 시에도 기본 카테고리 옵션은 제공
                    const cateSelect = document.getElementById('uidCate');
                    cateSelect.innerHTML = '<option value="">구분 선택</option>';
                    
                    // 기본 카테고리 추가
                    const defaultCates = ["DW", "MO", "PR", "TV", "ID", "ED", "DI", "TB", "PJ", "ET"];
                    defaultCates.forEach(cate => {
                        const option = document.createElement('option');
                        option.value = cate;
                        option.textContent = cate;
                        cateSelect.appendChild(option);
                    });
                    
                    const customOption = document.createElement('option');
                    customOption.value = 'custom';
                    customOption.textContent = '직접입력';
                    cateSelect.appendChild(customOption);
                    
                    console.log('오류 시 기본 고유번호 카테고리 옵션 추가 완료');
                });
        }

        // 고유번호 연도 로드
        function loadUidYears(schoolId, uidCate) {
            if (uidCate === 'custom') return;
            
            console.log('=== 고유번호 연도 로드 시작 ===');
            console.log('학교 ID:', schoolId);
            console.log('카테고리:', uidCate);
            
            fetch(`/api/uids/years/${schoolId}/${encodeURIComponent(uidCate)}`)
                .then(response => {
                    console.log('연도 API 응답 상태:', response.status);
                    if (response.status === 404) {
                        console.log('해당 카테고리의 연도 데이터가 없습니다.');
                        return [];
                    }
                    return response.json();
                })
                .then(years => {
                    console.log('받은 고유번호 연도 목록:', years);
                    const yearSelect = document.getElementById('uidYear');
                    yearSelect.innerHTML = '<option value="">연도 선택</option>';
                    
                    // years가 배열인지 확인
                    if (Array.isArray(years)) {
                        years.forEach(year => {
                            const option = document.createElement('option');
                            option.value = year;
                            option.textContent = year;
                            yearSelect.appendChild(option);
                        });
                    }
                    
                    const customOption = document.createElement('option');
                    customOption.value = 'custom';
                    customOption.textContent = '직접입력';
                    yearSelect.appendChild(customOption);
                    
                    console.log('고유번호 연도 옵션 추가 완료');
                })
                .catch(error => {
                    console.error('=== 고유번호 연도 API 호출 오류 ===');
                    console.error('오류:', error);
                    
                    // 오류 발생 시에도 직접입력 옵션은 제공
                    const yearSelect = document.getElementById('uidYear');
                    yearSelect.innerHTML = '<option value="">연도 선택</option>';
                    const customOption = document.createElement('option');
                    customOption.value = 'custom';
                    customOption.textContent = '직접입력';
                    yearSelect.appendChild(customOption);
                });
        }

        // 고유번호 번호 로드
        function loadUidNums(schoolId, uidCate, year) {
            if (uidCate === 'custom') return;
            
            let url = `/api/uids/nums/${schoolId}/${encodeURIComponent(uidCate)}`;
            if (year && year !== 'custom') {
                url = `/api/uids/nums/${schoolId}/${encodeURIComponent(uidCate)}?year=${year}`;
            }
            
            fetch(url)
                .then(response => {
                    console.log('고유번호 번호 API 응답 상태:', response.status);
                    if (response.status === 404) {
                        console.log('해당 카테고리의 번호 데이터가 없습니다.');
                        return [];
                    }
                    return response.json();
                })
                .then(nums => {
                    console.log('받은 고유번호 번호 목록:', nums);
                    const numSelect = document.getElementById('uidNum');
                    numSelect.innerHTML = '<option value="">번호 선택</option>';
                    
                    // nums가 배열인지 확인
                    if (Array.isArray(nums) && nums.length > 0) {
                        // 마지막 번호+1만 표시
                        const lastNum = nums[nums.length - 1]; // 마지막 번호 (신규)
                        
                        const option = document.createElement('option');
                        option.value = lastNum;
                        option.textContent = lastNum + ' (신규)';
                        option.selected = true; // 기본 선택
                        numSelect.appendChild(option);
                    } else {
                        // 번호가 없는 경우 1번을 신규로 추가
                        const option = document.createElement('option');
                        option.value = 1;
                        option.textContent = '1 (신규)';
                        option.selected = true;
                        numSelect.appendChild(option);
                    }
                    
                    const customOption = document.createElement('option');
                    customOption.value = 'custom';
                    customOption.textContent = '직접입력';
                    numSelect.appendChild(customOption);
                })
                .catch(error => {
                    console.error('고유번호 번호 로드 중 오류:', error);
                    
                    // 오류 발생 시에도 기본 옵션 제공
                    const numSelect = document.getElementById('uidNum');
                    numSelect.innerHTML = '<option value="">번호 선택</option>';
                    
                    const option = document.createElement('option');
                    option.value = 1;
                    option.textContent = '1 (신규)';
                    option.selected = true;
                    numSelect.appendChild(option);
                    
                    const customOption = document.createElement('option');
                    customOption.value = 'custom';
                    customOption.textContent = '직접입력';
                    numSelect.appendChild(customOption);
                });
        }

        // 유형에 따른 고유번호 카테고리 매핑
        function getUidCateByType(type) {
            switch (type) {
                case "데스크톱":
                    return "DW"; // 기본값, 실제로는 관리번호에 따라 결정됨
                case "모니터":
                    return "MO";
                case "프린터":
                    return "PR";
                case "TV":
                    return "TV";
                case "전자칠판":
                    return "ID";
                case "전자교탁":
                    return "ED";
                case "DID":
                    return "DI";
                case "태블릿":
                    return "TB";
                case "프로젝트":
                case "프로젝터":
                    return "PJ";
                default:
                    return "ET"; // 기타 장비
            }
        }

        // 이벤트 리스너 등록
        document.addEventListener('DOMContentLoaded', function() {
            const schoolSelect = document.querySelector('select[name="school"]');
            const manageCate = document.getElementById('manageCate');
            const manageYear = document.getElementById('manageYear');
            const typeSelect = document.getElementById('typeSelect');
            
                    // 학교 선택 이벤트
        schoolSelect.addEventListener('change', function() {
            console.log('=== 학교 선택 이벤트 발생 ===');
            console.log('선택된 학교 ID:', this.value);
            console.log('선택된 학교 텍스트:', this.options[this.selectedIndex].text);
            
            if (this.value) {
                console.log('학교 선택됨 - API 호출 시작:', this.value);
                loadManageCates(this.value);
                
                // 고유번호 카테고리 목록도 로드
                loadUidCates(this.value);
            } else {
                console.log('학교 선택 해제됨');
            }
        });
            
            // 관리번호 카테고리 선택 이벤트
            manageCate.addEventListener('change', function() {
                if (schoolSelect.value && this.value && this.value !== 'custom') {
                    loadYears(schoolSelect.value, this.value);
                    // 카테고리 선택 시 바로 번호 로드 (연도 상관없이)
                    loadManageNums(schoolSelect.value, this.value, null);
                    // 연도 초기화
                    manageYear.selectedIndex = 0;
                }
                setupCustomInput('manageCate', 'manageCateInput');
            });
            
            // 연도 선택 이벤트
            manageYear.addEventListener('change', function() {
                if (schoolSelect.value && manageCate.value && manageCate.value !== 'custom') {
                    if (this.value && this.value !== 'custom') {
                        // 연도가 선택된 경우: manageCate + year 조합으로 번호 로드
                        loadManageNums(schoolSelect.value, manageCate.value, this.value);
                    } else if (this.value === '') {
                        // 연도 선택이 해제된 경우: manageCate만으로 번호 로드
                        loadManageNums(schoolSelect.value, manageCate.value, null);
                    }
                }
                setupCustomInput('manageYear', 'manageYearInput');
            });

            // 번호 선택 이벤트
            const manageNum = document.getElementById('manageNum');
            manageNum.addEventListener('change', function() {
                setupCustomInput('manageNum', 'manageNumInput');
            });

            // 유형 선택 이벤트
            typeSelect.addEventListener('change', function() {
                const typeInput = document.getElementById('typeInput');
                const isCustom = this.value === 'CUSTOM';
                
                typeInput.style.display = isCustom ? 'block' : 'none';
                typeInput.required = isCustom;
                
                if (isCustom) {
                    typeInput.focus();
                    typeInput.value = '';
                    this.removeAttribute('name'); // select의 name 제거
                    typeInput.setAttribute('name', 'type'); // input에 name 설정
                } else {
                    this.setAttribute('name', 'type'); // select에 name 설정
                    typeInput.removeAttribute('name'); // input의 name 제거
                }

                // 유형 선택 시 고유번호 카테고리 자동 설정
                if (this.value && this.value !== 'CUSTOM' && schoolSelect.value) {
                    const uidCate = document.getElementById('uidCate');
                    const uidCateValue = getUidCateByType(this.value);
                    if (uidCateValue) {
                        // 기존 옵션 유지하면서 선택된 값 설정
                        uidCate.value = uidCateValue;
                        
                        // 연도와 번호 로드
                        loadUidYears(schoolSelect.value, uidCateValue);
                        loadUidNums(schoolSelect.value, uidCateValue, null);
                    }
                }
            });

            // 고유번호 관련 이벤트 리스너
            const uidCate = document.getElementById('uidCate');
            const uidYear = document.getElementById('uidYear');
            const uidNum = document.getElementById('uidNum');

            // 고유번호 카테고리 선택 이벤트
            uidCate.addEventListener('change', function() {
                console.log('=== 고유번호 카테고리 선택 이벤트 ===');
                console.log('선택된 카테고리:', this.value);
                console.log('학교 ID:', schoolSelect.value);
                
                if (schoolSelect.value && this.value && this.value !== 'custom') {
                    console.log('고유번호 연도 로드 시작');
                    loadUidYears(schoolSelect.value, this.value);
                    loadUidNums(schoolSelect.value, this.value, null);
                    uidYear.selectedIndex = 0;
                }
                setupCustomInput('uidCate', 'uidCateInput');
            });

            // 고유번호 연도 선택 이벤트
            uidYear.addEventListener('change', function() {
                console.log('=== 고유번호 연도 선택 이벤트 ===');
                console.log('선택된 연도:', this.value);
                
                if (schoolSelect.value && uidCate.value && uidCate.value !== 'custom') {
                    if (this.value && this.value !== 'custom') {
                        loadUidNums(schoolSelect.value, uidCate.value, this.value);
                    } else if (this.value === '') {
                        loadUidNums(schoolSelect.value, uidCate.value, null);
                    }
                }
                setupCustomInput('uidYear', 'uidYearInput');
            });

            // 고유번호 번호 선택 이벤트
            uidNum.addEventListener('change', function() {
                setupCustomInput('uidNum', 'uidNumInput');
            });
        });

        // 직접입력 기능
        function setupCustomInput(selectId, inputId) {
            const select = document.getElementById(selectId);
            const input = document.getElementById(inputId);
            
            input.style.display = select.value === 'custom' ? 'block' : 'none';
            if (select.value === 'custom') {
                input.required = true;
                select.required = false;
            } else {
                input.required = false;
                select.required = true;
            }
        }

        // 폼 제출 전 유효성 검사
        document.getElementById('deviceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // 필수 필드 검사
            const requiredFields = document.querySelectorAll('[required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                if (!field.value) {
                    isValid = false;
                    field.closest('.form-group').classList.add('has-error');
                } else {
                    field.closest('.form-group').classList.remove('has-error');
                }
            });
            
            if (isValid) {
                this.submit();
            } else {
                alert('필수 항목을 모두 입력해주세요.');
            }
        });
    </script>
</body>
</html> 