<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>IP 대장 - 테스트</title>
    <link rel="stylesheet" href="/device.css">
    <link rel="stylesheet" href="/main.css" />
    <link rel="stylesheet" href="/ip.css" />
    <link rel="stylesheet" href="/navbar.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: white;
        }

        .device-form-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
        }

        .title {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #eee;
        }

        .subject {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .filter-container {
            margin-bottom: 24px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .filter-form select {
            padding: 8px 16px;
            margin-right: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            color: #333;
            background-color: white;
            min-width: 200px;
        }

        .filter-form select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
        }

        .ip-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 6px;
            padding: 3px;
        }

        .ip-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 3px;
            padding: 6px;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .ip-item:hover {
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .ip-item.used {
            background-color: white;
            border: 1px solid #e0e0e0;
        }

        .ip-item.ip-warning {
            background-color: #fff5f5;
            border-color: #ffcdd2;
        }

        .ip-number {
            font-size: 12px;
            font-weight: 600;
            color: #2196F3;
            margin-bottom: 4px;
            padding-bottom: 3px;
            border-bottom: 1px solid #eee;
        }

        .ip-info {
            font-size: 10px;
        }

        .device-type {
            font-weight: 500;
            color: #333;
            margin-bottom: 2px;
            font-size: 11px;
        }

        .manage-number {
            color: #1976d2;
            font-family: 'Consolas', monospace;
            margin-bottom: 2px;
            padding: 1px 3px;
            background: rgba(25, 118, 210, 0.1);
            border-radius: 2px;
            display: inline-block;
            font-size: 9px;
            line-height: 1.2;
        }

        .device-model {
            color: #555;
            margin-bottom: 2px;
            font-size: 9px;
            line-height: 1.2;
        }

        .device-location {
            color: #666;
            font-style: italic;
            font-size: 9px;
            margin-top: 3px;
            padding-top: 3px;
            border-top: 1px dashed #eee;
            line-height: 1.2;
        }

        .no-school-message {
            text-align: center;
            padding: 40px 20px;
            background: #f8f9fa;
            border-radius: 8px;
            color: #666;
        }

        .no-school-message i {
            font-size: 32px;
            margin-bottom: 16px;
            color: #999;
            display: block;
        }

        .no-school-message p {
            font-size: 16px;
            margin: 0;
        }

        .btn-primary {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background-color: #4CAF50;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: #43A047;
        }

        .btn-primary i {
            font-size: 16px;
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .ip-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .filter-form select {
                width: 100%;
                margin-bottom: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- 네비게이션 바 포함 -->
    <div th:replace="~{fragments/navbar :: navbar}"></div>
    
    <div class="container">
        <div class="device-form-container">
            <div class="title">
                <div class="subject">IP 대장</div>
                <div class="subtitle">IP 주소별 장비 현황을 확인할 수 있습니다.</div>
                <!-- 엑셀 다운로드 버튼 추가 -->
                <div th:if="${selectedSchool != null}" style="margin-top: 10px;">
                    <a th:href="@{/ip/download(schoolId=${selectedSchool.schoolId}, secondOctet=${selectedSecondOctet})}" 
                       class="btn btn-primary" id="excelDownloadBtn" onclick="downloadExcel(event)">
                        <i class="fas fa-file-excel"></i> 엑셀 다운로드
                    </a>
                </div>
            </div>

            <!-- 필터 컨테이너 -->
            <div class="filter-container">
                <form id="filterForm" th:action="@{/ip/iplist}" method="get" class="filter-form">
                    <!-- 학교 선택 -->
                    <select id="schoolSelect" name="schoolId" onchange="this.form.submit()">
                        <option value="">학교 선택</option>
                        <option th:each="school : ${schools}"
                                th:value="${school.schoolId}"
                                th:text="${school.schoolName}"
                                th:selected="${selectedSchool != null && selectedSchool.schoolId == school.schoolId}">
                        </option>
                    </select>
                    
                    <!-- 두 번째 옥텟 선택 -->
                    <select id="secondOctetSelect" name="secondOctet" onchange="this.form.submit()" 
                            th:if="${selectedSchool != null && secondOctets != null}">
                        <option value="all">전체 IP 대역</option>
                        <option th:each="octet : ${secondOctets}"
                                th:value="${octet}"
                                th:text="${'10.' + octet + '.x.x'}"
                                th:selected="${selectedSecondOctet != null && selectedSecondOctet == octet}">
                        </option>
                    </select>
                </form>
            </div>

            <!-- IP 목록 표시 -->
            <div th:if="${selectedSchool != null}">
                <!-- 전체 IP 대역 보기 -->
                <div th:if="${isAllView}" th:each="entry : ${ipListByOctet}">
                    <div class="ip-section-header" style="background: #f5f5f5; padding: 10px; margin: 20px 0 10px; border-radius: 4px; font-weight: bold;">
                        <span th:text="${'IP 대역: 10.' + entry.key + '.36.x'}">IP 대역</span>
                    </div>
                    <div class="ip-grid">
                        <div th:each="ip : ${entry.value}" class="ip-item" 
                             th:classappend="${ip.device != null ? 'used' : ''} + ' ' + ${ip.number >= 245 && ip.number <= 254 ? 'ip-warning' : ''}"
                             th:attr="data-ip-number=${ip.number}, data-device-id=${ip.device != null ? ip.device.deviceId : null}">
                            <div class="ip-number" th:text="${ip.number}">1</div>
                            <div class="ip-info" th:if="${ip.device != null}">
                                <div class="device-type" th:text="${ip.device.type}">장비유형</div>
                                <div class="manage-number" th:if="${ip.device.manage != null}" 
                                     th:text="${(ip.device.manage.manageCate != null ? ip.device.manage.manageCate : '') + 
                                             (ip.device.manage.manageCate != null ? '-' : '') +
                                             (ip.device.manage.year != null ? ip.device.manage.year + '-' : '') + 
                                             (ip.device.manage.manageNum != null ? #numbers.formatInteger(ip.device.manage.manageNum, 2) : '')}">
                                    관리번호
                                </div>
                                <div class="device-model" th:if="${ip.device.modelName != null}" th:text="${ip.device.modelName}">모델명</div>
                                <div class="device-location" th:text="${ip.device.classroom != null ? ip.device.classroom.roomName : '위치 미지정'}">설치위치</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 단일 IP 대역 보기 -->
                <div th:if="${!isAllView}" class="ip-grid">
                    <div th:each="ip : ${ipList}" class="ip-item" 
                         th:classappend="${ip.device != null ? 'used' : ''} + ' ' + ${ip.number >= 245 && ip.number <= 254 ? 'ip-warning' : ''}"
                         th:attr="data-ip-number=${ip.number}, data-device-id=${ip.device != null ? ip.device.deviceId : null}">
                        <div class="ip-number" th:text="${ip.number}">1</div>
                        <div class="ip-info" th:if="${ip.device != null}">
                            <div class="device-type" th:text="${ip.device.type}">장비유형</div>
                            <div class="manage-number" th:if="${ip.device.manage != null}" 
                                 th:text="${(ip.device.manage.manageCate != null ? ip.device.manage.manageCate : '') + 
                                         (ip.device.manage.manageCate != null ? '-' : '') +
                                         (ip.device.manage.year != null ? ip.device.manage.year + '-' : '') + 
                                         (ip.device.manage.manageNum != null ? #numbers.formatInteger(ip.device.manage.manageNum, 2) : '')}">
                                관리번호
                            </div>
                            <div class="device-model" th:if="${ip.device.modelName != null}" th:text="${ip.device.modelName}">모델명</div>
                            <div class="device-location" th:text="${ip.device.classroom != null ? ip.device.classroom.roomName : '위치 미지정'}">설치위치</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 학교 미선택 시 안내 메시지 -->
            <div class="no-school-message" th:if="${selectedSchool == null}">
                <i class="fas fa-info-circle"></i>
                <p>학교를 선택하면 IP 현황이 표시됩니다.</p>
            </div>
        </div>
    </div>
    
    <!-- 푸터 포함 -->
    <div th:replace="~{fragments/footer :: footer}"></div>
    
    <script>
        // 엑셀 다운로드 진행 표시
        function downloadExcel(event) {
            if (event) {
                event.preventDefault();
            }
            
            const excelBtn = document.getElementById('excelDownloadBtn');
            const originalHtml = excelBtn.innerHTML;
            excelBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 엑셀 다운로드 중...';
            excelBtn.style.pointerEvents = 'none';
            
            if (excelBtn && excelBtn.href) {
                window.location.href = excelBtn.href;
                // 다운로드 시작 후 버튼 복원 (약간의 지연)
                setTimeout(() => {
                    excelBtn.innerHTML = originalHtml;
                    excelBtn.style.pointerEvents = '';
                }, 2000);
            }
        }
        
        // IP 카드 클릭 이벤트 (장비 수정 페이지로 이동)
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.ip-item.used').forEach(function(ipItem) {
                ipItem.addEventListener('click', function() {
                    const deviceId = this.getAttribute('data-device-id');
                    if (deviceId) {
                        window.location.href = '/device/modify/' + deviceId;
                    }
                });
            });
        });
    </script>
</body>
</html> 